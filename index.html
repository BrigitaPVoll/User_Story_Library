
!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>User Story Library | DeiC style</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <style>
    /* ==== DeiC-inspired palette & layout variables ==== */
    :root{
      --deic-green: #BFD730;
      --deic-sprout: #C9E1BD;
      --deic-blue:  #16385D;

      /* Page background: not white */
      --bg: #f2f5f0;            /* soft warm green-grey */
      --fg: #0b1221;
      --muted: #667085;

      --card: #f8faf7;
      --border: #dfe6d8;

      --accent: var(--deic-green);
      --accent-contrast: #0b1221;

      /* Header & controls */
      --header-bg: color-mix(in oklab, var(--deic-blue) 8%, var(--bg));
      --header-border: color-mix(in oklab, var(--deic-green) 28%, white);
      --accent-soft: color-mix(in oklab, var(--deic-green) 18%, white);

      --control-bg: #ffffff;
      --control-border: #cfd8c8;
      --control-shadow: 0 4px 12px rgba(0,0,0,.07);

      --link: var(--deic-blue);
      --shadow: 0 6px 18px rgba(0,0,0,.08);
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg: #0e1523;
        --fg: #eef2f7;
        --muted: #aeb9c7;
        --card: #121a28;
        --border: #243045;
        --accent-contrast: #0e1523;
        --header-bg: #0f1b2b;
        --header-border: #33527a;
        --control-bg: #0f1726;
        --control-border: #243045;
        --control-shadow: 0 6px 16px rgba(0,0,0,.25);
        --link: #8bb3e8;
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 600px at 10% -10%, color-mix(in oklab, var(--deic-green) 8%, transparent), transparent 45%),
        radial-gradient(900px 450px at 85% 0%, color-mix(in oklab, var(--deic-sprout) 8%, transparent), transparent 45%),
        var(--bg);
      color:var(--fg);
      line-height:1.55;
    }

    /* ==== Header (opaque & elevated for contrast) ==== */
    header{
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--header-bg);
      border-bottom: 4px solid var(--header-border);
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:1rem 1.25rem}
    .bar{display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:.75rem}
    .logo{
      width:40px; height:40px; border-radius:10px;
      background: conic-gradient(from 180deg, var(--deic-green), var(--deic-sprout), var(--deic-blue), var(--deic-green));
      box-shadow:var(--shadow); border:1px solid var(--border);
    }
    h1{font-size: clamp(1.1rem, 2vw, 1.6rem); margin:0; letter-spacing:.2px; color: var(--deic-blue); font-weight:700}
    .tagline{color: color-mix(in oklab, var(--muted) 85%, #000); font-size:.95rem; margin:.3rem 0 0 0; max-width:900px}

    .cta-row{display:flex; align-items:center; gap:.5rem; flex-wrap:wrap}
    .button-link{
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.6rem .8rem; border-radius:.6rem; border:1px solid var(--control-border);
      background: var(--accent); color: var(--accent-contrast); font-weight:600; text-decoration:none;
      box-shadow: var(--control-shadow);
    }
    .button-link:hover{filter:brightness(1.05)}
    .secondary{ background: var(--control-bg); color: var(--fg); border-color: var(--control-border) }

    /* ==== Controls: crisp white surface ==== */
    .controls{display:grid; grid-template-columns:1fr; gap:.75rem; margin-top:.75rem; background: color-mix(in oklab, var(--control-bg) 94%, transparent); border: 1px solid var(--control-border); border-radius: 12px; padding: .8rem; box-shadow: var(--control-shadow);}
    .controls-row{display:grid; grid-template-columns:2fr 1fr 1fr auto auto; gap:.5rem}
    @media (max-width:1000px){ .controls-row{grid-template-columns:1fr 1fr 1fr 1fr} }
    @media (max-width:700px){ .controls-row{grid-template-columns:1fr 1fr} }
    @media (max-width:520px){ .controls-row{grid-template-columns:1fr} }

    label{font-size:.85rem; color:var(--muted)}
    input, select, button{
      padding:.6rem .7rem; border-radius:.6rem; border:1px solid var(--control-border);
      background:var(--control-bg); color:var(--fg); outline:none;
    }
    input, select{width:100%}
    button.primary{background:var(--accent); color:var(--accent-contrast); border:none; font-weight:600; box-shadow:var(--control-shadow); cursor:pointer}
    button.primary:hover{filter:brightness(1.06)}
    .token-box{display:none}
    .inline{display:flex; align-items:center; gap:.5rem}
    small{color:var(--muted)}

    /* ==== Main content ==== */
    main{max-width:1100px; margin:0 auto; padding:1rem 1.25rem 3rem}
    .status{margin:1rem 0; font-size:.95rem; color:var(--muted); display:flex; align-items:center; gap:.75rem; flex-wrap:wrap}
    .rate{font-size:.85rem; color:var(--muted); padding:.1rem .4rem; border:1px solid var(--control-border); border-radius:999px; background:var(--control-bg)}
    .grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); gap:1rem}
    .card{
      background: var(--card);
      border:1px solid var(--border); border-radius:14px; padding:1rem; box-shadow:var(--shadow);
      display:flex; flex-direction:column; gap:.6rem
    }
    .card h3{margin:.1rem 0 .25rem; font-size:1.05rem; line-height:1.35}
    .meta{display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; color:var(--muted); font-size:.85rem}
    .labels{display:flex; gap:.35rem; flex-wrap:wrap}
    .label{background: color-mix(in oklab, var(--deic-green) 15%, white); color:var(--fg); border:1px solid var(--border); border-radius:999px; padding:.15rem .55rem; font-size:.78rem}
    .assignees{display:flex; align-items:center; gap:.35rem}
    .assignees img{width:20px; height:20px; border-radius:50%; border:1px solid var(--border)}
    .pill{border-radius:999px; padding:.12rem .5rem; font-size:.78rem; border:1px solid var(--border)}
    .pill.ok{background: color-mix(in oklab, #22c55e 18%, white); color:var(--fg)}
    .pill.no{background: color-mix(in oklab, #ef4444 18%, white); color:var(--fg)}
    .pill.na{background: color-mix(in oklab, #f59e0b 18%, white); color:var(--fg)}
    .desc{font-size:.95rem}
    .story-parts{display:flex; flex-wrap:wrap; gap:.35rem}
    .story-part{border:1px dashed var(--border); border-radius:8px; padding:.25rem .5rem; font-size:.82rem; color:var(--muted)}
    .empty,.error{text-align:center; color:var(--muted); padding:2rem 0}
    a { color: var(--link); text-decoration: none }
    a:hover { text-decoration: underline }
    .notice { font-size: .82rem; color: var(--muted) }

    /* ==== Modal (New User Story) ==== */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:50}
    .modal{width:min(720px, 92vw); background:var(--control-bg); color:var(--fg); border:1px solid var(--control-border); border-radius:14px; box-shadow:0 16px 40px rgba(0,0,0,.18)}
    .modal header{position:static; background:var(--control-bg); border-bottom:1px solid var(--control-border); box-shadow:none}
    .modal .wrap{padding:1rem 1.25rem}
    .modal h2{margin:.2rem 0 0; font-size:1.2rem; color:var(--deic-blue)}
    .modal .grid-form{display:grid; grid-template-columns:1fr 1fr; gap:.8rem}
    .modal .grid-form .full{grid-column:1/-1}
    .modal .actions{display:flex; justify-content:flex-end; gap:.5rem; margin-top:.5rem}

    textarea{min-height:100px; resize:vertical}

    /* ==== Print-friendly styling (for "Save as PDF") ==== */
    @page { size: A4; margin: 16mm; }
    @media print {
      header, .controls, .status, .load-more, footer, .modal-backdrop, #detail-drawer { display: none !important; }
      body { background: #fff; }
      main { padding: 0 }
      .grid { grid-template-columns: 1fr; gap: .8rem; }
      .card { box-shadow: none; border-color: #ddd; }
      a[href]::after { content: " (" attr(href) ")"; font-size: .8em; color: #888; }
    }

    /* === NEW: Detail Drawer (issue viewer) === */
    #detail-drawer {
      position: fixed;
      top: 0;
      right: 0;
      height: 100%;
      width: min(760px, 96vw);
      background: var(--control-bg);
      color: var(--fg);
      border-left: 1px solid var(--control-border);
      box-shadow: -12px 0 30px rgba(0,0,0,.18);
      transform: translateX(110%);
      transition: transform .28s ease;
      z-index: 60;
      display: flex;
      flex-direction: column;
    }
    #detail-drawer.open { transform: translateX(0); }
    #detail-header {
      display:flex; align-items:center; justify-content:space-between; gap:.6rem;
      padding: .9rem 1rem; border-bottom: 1px solid var(--control-border);
      background: color-mix(in oklab, var(--control-bg) 90%, transparent);
    }
    #detail-title { font-size: 1.05rem; font-weight: 700; color: var(--deic-blue); margin: 0; }
    #detail-body { padding: 1rem; overflow: auto; }
    #detail-body .section { margin-bottom: 1rem; }
    .btn-ghost { background: transparent; border:1px solid var(--control-border); padding:.5rem .7rem; border-radius:.6rem; cursor:pointer; color: var(--fg); }
    .btn-ghost:hover{ background: color-mix(in oklab, var(--accent) 10%, white); }
    .story-badge { border:1px dashed var(--border); border-radius: 8px; padding:.25rem .5rem; font-size:.85rem; color: var(--muted); }
    .markdown h1,.markdown h2,.markdown h3{margin: .8rem 0 .4rem; color: var(--deic-blue)}
    .markdown code{background: color-mix(in oklab, #888 12%, white); padding:.05rem .35rem; border-radius:.3rem}
    .markdown pre code{display:block; padding:.6rem .8rem; overflow:auto}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="bar" role="navigation" aria-label="Top bar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>User Story Library</h1>
            <p class="tagline">A FAIR use case is a concrete description of who needs what kind of data, for what purpose, and under what conditions.</p>
          </div>
        </div>
        <div class="cta-row">
          <button id="open-modal" class="button-link">New Story</button>
          <button id="export" class="button-link secondary">Export CSV</button>
          <button id="print" class="button-link secondary">Print / Save PDF</button>
        </div>
      </div>

      <div class="controls" aria-label="Filters and configuration">
        <div class="controls-row">
          <div>
            <label for="search">Search</label>
            <input id="search" type="text" placeholder="Search title, story, context or #number…" />
          </div>
          <div>
            <label for="state">State</label>
            <select id="state">
              <option value="open" selected>Open</option>
              <option value="closed">Closed</option>
              <option value="all">All</option>
            </select>
          </div>
          <div class="inline" style="align-items:end">
            <button id="refresh" class="primary">Refresh</button>
            <button id="toggle-token" aria-expanded="false" aria-controls="token-box">Token</button>
          </div>
          <div class="inline" style="align-items:end">
            <label class="inline" style="gap:.4rem" title="Show only issues that contain a valid 'As a…, I want to…, so that I can…' sentence">
              <input id="only-template" type="checkbox" checked />
              Only valid stories
            </label>
          </div>
          <div class="inline" style="align-items:end">
            <small>Backend: <a href="https://github.com/BrigitaPVoll/User_Story_Library" target="_blank" rel="noopener">BrigitaPVoll/User_Story_Library</a></small>
          </div>
        </div>

        <div id="token-box" class="token-box">
          <label for="token">GitHub Token (optional, required for creating issues)</label>
          <input id="token" type="password" placeholder="ghp_… (classic) or fine-grained token" />
          <div class="notice">
            Stored locally in your browser (localStorage) to raise API limits and enable issue creation.
            Docs: <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens" target="_blank" rel="noopener">PATs</a>,
            <a href="https://stackoverflow.com/questions/63906613/minimal-set-of-scopes-to-push-to-github-using-an-access-token" target="_blank" rel="noopener">scopes</a>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="status" id="status" aria-live="polite">
        <span id="rate" class="rate" title="GitHub REST API rate limit">API …</span>
      </div>
      <section id="stories" class="grid" aria-label="User stories list"></section>
      <div class="empty" id="empty" style="display:none;">No user stories found.</div>
      <div class="error" id="error" style="display:none;"></div>

      <div class="load-more" style="display:flex; justify-content:center; margin-top:1rem;">
        <button id="more" style="display:none;">Load more</button>
      </div>
    </div>
  </main>

  <footer>
    <div class="wrap"><small>Powered by GitHub Issues • DeiC-inspired UI</small></div>
  </footer>

  <!-- ==== Modal: New User Story (Create GitHub Issue) ==== -->
  <div id="backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal">
      <header>
        <div class="wrap">
          <h2 id="modal-title">New User Story</h2>
          <p class="notice">Creates a GitHub Issue directly in <strong>BrigitaPVoll/User_Story_Library</strong>.</p>
        </div>
      </header>
      <div class="wrap">
        <form id="story-form">
          <div class="grid-form">
            <div class="full">
              <label for="title">Title (required)</label>
              <input id="title" type="text" placeholder="Short descriptive title" required />
            </div>

            <div>
              <label for="role">As a… (role)</label>
              <input id="role" type="text" placeholder="e.g., conservation biologist" />
            </div>
            <div>
              <label for="goal">I want to… (goal)</label>
              <input id="goal" type="text" placeholder="e.g., reuse butterfly observation data" />
            </div>

            <div class="full">
              <label for="benefit">…so that I can… (benefit)</label>
              <input id="benefit" type="text" placeholder="e.g., study changes in biodiversity across landscapes" />
            </div>

            <div class="full">
              <label for="context">Additional context</label>
              <textarea id="context" placeholder="Any other context about the user story here."></textarea>
            </div>

            <div>
              <label>Contact consent</label>
              <select id="consent">
                <option value="Yes">Yes</option>
                <option value="No">No</option>
                <option value="N/A" selected>N/A</option>
              </select>
            </div>

            <div>
              <label for="labels">Labels (comma)</label>
              <input id="labels" type="text" value="user-story" />
            </div>

            <div class="full">
              <label for="assignees">Assignees (comma GitHub usernames, optional)</label>
              <input id="assignees" type="text" placeholder="e.g., BrigitaPVoll" />
            </div>
          </div>

          <div class="actions">
            <button type="button" id="cancel-modal">Cancel</button>
            <button type="submit" class="primary">Create Story</button>
          </div>

          <p class="notice" style="margin-top:.5rem;">
            Requires a GitHub token (set in <strong>Token</strong>) with permission to create issues.
            Public repo: classic <code>public_repo</code> or fine‑grained token with <em>Contents: Read &amp; write</em> on this repo.
            See <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens" target="_blank" rel="noopener">docs</a>.
          </p>
        </form>
      </div>
    </div>
  </div>

  <!-- === NEW: Right-side detail drawer === -->
  <aside id="detail-drawer" aria-hidden="true" aria-label="User story detail">
    <div id="detail-header">
      <h3 id="detail-title">Loading…</h3>
      <div style="display:flex; gap:.5rem; align-items:center">
        <button id="toggle-comments" class="btn-ghost" title="Load comments">Comments</button>
        <a id="detail-gh" class="btn-ghost" target="_blank" rel="noopener">Open in GitHub</a>
        <button id="detail-close" class="btn-ghost" aria-label="Close">Close</button>
      </div>
    </div>
    <div id="detail-body">
      <div class="section" id="detail-meta"></div>
      <div class="section" id="detail-story"></div>
      <div class="section markdown" id="detail-markdown"></div>
      <div class="section" id="detail-comments" style="display:none;"></div>
    </div>
  </aside>

  <script>
    // ---------- Configuration ----------
    const OWNER = 'BrigitaPVoll';
    const REPO  = 'User_Story_Library';
    const PER_PAGE = 20;

    // ---------- State ----------
    let currentPage = 1;
    let lastBatch = [];
    let accumulated = [];

    // ---------- DOM ----------
    const $ = sel => document.querySelector(sel);
    const storiesEl = $('#stories');
    const statusEl  = $('#status');
    const emptyEl   = $('#empty');
    const errorEl   = $('#error');
    const moreBtn   = $('#more');

    const tokenBox = $('#token-box');
    const tokenInput = $('#token');

    const backdrop = $('#backdrop');
    const openModalBtn = $('#open-modal');
    const cancelModalBtn = $('#cancel-modal');
    const storyForm = $('#story-form');
    const rateEl = $('#rate');

    // NEW: Detail drawer elements
    const drawer = $('#detail-drawer');
    const detailTitle = $('#detail-title');
    const detailMeta = $('#detail-meta');
    const detailStory = $('#detail-story');
    theDetailMarkdown = $('#detail-markdown'); // intentionally without 'const' to avoid redeclaration in some bundlers
    const detailMarkdown = theDetailMarkdown;
    const detailComments = $('#detail-comments');
    const detailCloseBtn = $('#detail-close');
    const ghLink = $('#detail-gh');
    const toggleCommentsBtn = $('#toggle-comments');

    // ---------- Utilities ----------
    function escapeHTML(str){
      return String(str ?? '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[s]);
    }
    function fmtDate(iso){
      try{
        const d = new Date(iso);
        return new Intl.DateTimeFormat('en', {dateStyle:'medium', timeStyle:'short'}).format(d);
      }catch{ return iso || '' }
    }
    function setStatus(text){ statusEl.firstChild ? statusEl.firstChild.textContent = text || '' : (statusEl.textContent = text || ''); }
    function showError(msg){
      errorEl.style.display='block';
      errorEl.textContent = 'Error: ' + msg;
      setStatus('');
    }
    function updateRateFromHeaders(h){
      try{
        const limit = h.get('x-ratelimit-limit');
        const remaining = h.get('x-ratelimit-remaining');
        const reset = h.get('x-ratelimit-reset');
        if(limit && remaining && rateEl){
          const secs = reset ? Math.max(0, parseInt(reset,10) - Math.floor(Date.now()/1000)) : null;
          const mins = secs!=null ? Math.ceil(secs/60) : null;
          rateEl.textContent = `API ${remaining}/${limit}${mins!=null ? ` (resets ~${mins}m)` : ''}`;
        }
      }catch{}
    }

    // ---------- Parse template from issue body ----------
    function parseStory(body){
      const raw = body || '';
      const lines = raw.split(/\r?\n/);

      const storyLineIdx = lines.findIndex(l => /^(\s*\*\*)?\s*As a\b/i.test(l));
      const storyLine = storyLineIdx >= 0 ? lines[storyLineIdx].replace(/^\s*\*\*|\*\*\s*$/g,'').trim() : '';

      let role='', goal='', benefit='';
      const m = storyLine.replace(/\*\*/g,'')
        .match(/As a\s+(.*?)[,;]?\s*I\s+want\s+to\s+(.*?)[,;]?\s*so\s+that\s+I\s+can\s+(.*?)(?:\.|$)/i);
      if (m){ role=m[1].trim(); goal=m[2].trim(); benefit=m[3].trim(); }

      const ctxHeaderIdx = lines.findIndex(l => /additional\s+context/i.test(l));
      let context = '';
      if (ctxHeaderIdx >= 0){
        const nextHeaderIdx = lines.slice(ctxHeaderIdx+1).findIndex(l => /can\s+we\s+contact\s+you/i.test(l));
        const end = nextHeaderIdx >= 0 ? ctxHeaderIdx + 1 + nextHeaderIdx : lines.length;
        context = lines.slice(ctxHeaderIdx+1, end).join('\n').trim();
        context = context.replace(/^\s*\*\*|\*\*\s*$/gm,'').trim();
      }

      const consentIdx = lines.findIndex(l => /can\s+we\s+contact\s+you/i.test(l));
      let consent = 'N/A';
      if (consentIdx >= 0){
        const answerLine = (lines[consentIdx+1] || '').trim();
        const yn = (answerLine.match(/yes|no/i) || [])[0];
        if (yn) consent = /^yes$/i.test(yn) ? 'Yes' : 'No';
      }

      return { storyLine, role, goal, benefit, context, consent };
    }

    // === NEW: Minimal Markdown -> HTML (safe-ish) ===
    function markdownToHTML(md){
      if (!md) return '';
      let s = md;

      // Escape first, then re-introduce markdown constructs
      s = escapeHTML(s);

      // Headings
      s = s.replace(/^###### (.*)$/gm, '<h6>$1</h6>')
           .replace(/^##### (.*)$/gm, '<h5>$1</h5>')
           .replace(/^#### (.*)$/gm, '<h4>$1</h4>')
           .replace(/^### (.*)$/gm, '<h3>$1</h3>')
           .replace(/^## (.*)$/gm, '<h2>$1</h2>')
           .replace(/^# (.*)$/gm, '<h1>$1</h1>');

      // Code blocks ``` ```
      s = s.replace(/```([\s\S]*?)```/g, (m, code) => `<pre><code>${code}</code></pre>`);

      // Inline code
      s = s.replace(/`([^`]+)`/g, '<code>$1</code>');

      // Bold/italic
      s = s.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
           .replace(/\*([^*]+)\*/g, '<em>$1</em>');

      // Links [text](url)
      s = s.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');

      // Lists (simple)
      s = s.replace(/(^|\n)\s*-\s+(.*)(?=\n|$)/g, '$1<li>$2</li>');
      s = s.replace(/(<li>[\s\S]*?<\/li>)/g, '<ul>$1</ul>').replace(/<\/ul>\s*<ul>/g, '');

      // Paragraphs (simple)
      s = s.replace(/(\n\s*\n)/g, '</p><p>');
      s = `<p>${s}</p>`.replace(/<p>\s*<\/p>/g,'');

      return s;
    }

    // ---------- GitHub API ----------
    function buildIssuesURL({state, page}){
      const base = `https://api.github.com/repos/${encodeURIComponent(OWNER)}/${encodeURIComponent(REPO)}/issues`;
      const params = new URLSearchParams({
        state: state || 'open',
        per_page: String(PER_PAGE),
        page: String(page || 1)
      });
      return `${base}?${params}`;
    }

    async function fetchIssues({append=false}={}){
      const state = $('#state').value;
      const url = buildIssuesURL({state, page: currentPage});
      const headers = { 'Accept': 'application/vnd.github+json' };
      const token = localStorage.getItem('GITHUB_TOKEN') || tokenInput.value.trim();
      if (token) headers['Authorization'] = `Bearer ${token}`;

      try{
        if(!append){ setStatus('Loading user stories… '); errorEl.style.display='none'; }
        const res = await fetch(url, { headers });
        updateRateFromHeaders(res.headers);
        if(!res.ok){
          if(res.status === 401) throw new Error('401 Unauthorized — invalid or missing token');
          if(res.status === 403) throw new Error('403 Forbidden or rate-limited — add a token or wait and retry');
          const text = await res.text();
          throw new Error(`${res.status} ${res.statusText} — ${text}`);
        }
        const data = await res.json();
        const issues = data.filter(it => !it.pull_request);

        lastBatch = issues;
        if (append){ accumulated = accumulated.concat(issues); }
        else { accumulated = issues; }

        renderIssues(accumulated);
        setStatus(`Loaded ${accumulated.length} user stor${accumulated.length===1?'y':'ies'}`);
        moreBtn.style.display = issues.length === PER_PAGE ? 'inline-block' : 'none';
      }catch(err){ showError(err.message); }
    }

    // === NEW: Fetch a single issue by number ===
    async function fetchIssue(number){
      const url = `https://api.github.com/repos/${encodeURIComponent(OWNER)}/${encodeURIComponent(REPO)}/issues/${number}`;
      const headers = { 'Accept': 'application/vnd.github+json' };
      const token = localStorage.getItem('GITHUB_TOKEN') || tokenInput.value.trim();
      if (token) headers['Authorization'] = `Bearer ${token}`;

      const res = await fetch(url, { headers });
      updateRateFromHeaders(res.headers);
      if (!res.ok){
        const text = await res.text();
        throw new Error(`${res.status} ${res.statusText} — ${text}`);
      }
      return res.json();
    }

    // === NEW: Fetch comments for an issue (first page) ===
    async function fetchComments(number){
      const url = `https://api.github.com/repos/${encodeURIComponent(OWNER)}/${encodeURIComponent(REPO)}/issues/${number}/comments?per_page=50`;
      const headers = { 'Accept': 'application/vnd.github+json' };
      const token = localStorage.getItem('GITHUB_TOKEN') || tokenInput.value.trim();
      if (token) headers['Authorization'] = `Bearer ${token}`;
      const res = await fetch(url, { headers });
      updateRateFromHeaders(res.headers);
      if (!res.ok){
        const text = await res.text();
        throw new Error(`${res.status} ${res.statusText} — ${text}`);
      }
      return res.json();
    }

    // ---------- Rendering ----------
    function renderIssues(items){
      const q = ($('#search').value || '').toLowerCase().trim();
      const onlyTemplate = $('#only-template').checked;

      const filtered = items.filter(i => {
        const parsed = parseStory(i.body);
        const hasStory = parsed.storyLine && /As a\b/i.test(parsed.storyLine);
        if (onlyTemplate && !hasStory) return false;

        if (!q) return true;
        const hay = [
          i.title || '',
          i.number,
          parsed.storyLine || '',
          parsed.context || '',
          (i.labels||[]).map(l=>l.name).join(' ')
        ].join(' ').toLowerCase();
        return hay.includes(q);
      });

      storiesEl.innerHTML = '';
      emptyEl.style.display = filtered.length ? 'none' : 'block';

      for (const i of filtered){
        const parsed = parseStory(i.body);
        const labels = (i.labels||[]).map(l=>l.name).sort();
        const assignees = (i.assignees||[]);
        const updated = i.updated_at ? fmtDate(i.updated_at) : '';
        const title = (i.title && i.title.trim()) || parsed.storyLine || `(issue #${i.number})`;

        const storyParts = (parsed.role || parsed.goal || parsed.benefit)
          ? `<div class="story-parts">
               ${parsed.role ? `<span class="story-part">Role: ${escapeHTML(parsed.role)}</span>`:''}
               ${parsed.goal ? `<span class="story-part">Goal: ${escapeHTML(parsed.goal)}</span>`:''}
               ${parsed.benefit ? `<span class="story-part">Benefit: ${escapeHTML(parsed.benefit)}</span>`:''}
             </div>` : '';

        const consentPill = parsed.consent === 'Yes' ? 'ok' : (parsed.consent === 'No' ? 'no' : 'na');

        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <h3>
            <!-- CHANGED: make title a button that opens the viewer -->
            <button class="btn-ghost open-issue" data-number="${i.number}" title="Open in page">${escapeHTML(title)}</button>
          </h3>
          <div class="meta">
            <span>#${i.number}</span><span>•</span>
            <span>${escapeHTML(i.state)}</span>
            ${updated ? `<span>•</span><span>Updated ${escapeHTML(updated)}</span>` : ''}
          </div>

          ${parsed.storyLine ? `<div class="desc">${escapeHTML(parsed.storyLine)}</div>`:''}
          ${storyParts}

          ${parsed.context ? `
            <div>
              <div class="meta" style="margin-top:.25rem;"><strong>Additional context</strong></div>
              <div class="desc" style="white-space:pre-wrap;">${escapeHTML(parsed.context)}</div>
            </div>` : ''}

          <div class="meta" style="margin-top:.35rem;">
            <span class="pill ${consentPill}">Contact consent: ${escapeHTML(parsed.consent)}</span>
          </div>

          <div class="meta">
            <div class="labels">
              ${labels.map(name => `<span class="label">${escapeHTML(name)}</span>`).join('')}
            </div>
          </div>

          ${assignees.length ? `
            <div class="meta assignees">
              <span>Assignees:</span>
              ${assignees.map(a=>`<img src="${escapeHTML(a.avatar_url)}" alt="${escapeHTML(a.login)}" />`).join('')}
            </div>` : ''}

          <div class="meta">
            <!-- Keep GitHub as secondary action -->
            <a href="${escapeHTML(i.html_url)}" target="_blank" rel="noopener">Open in GitHub</a>
          </div>
        `;
        storiesEl.appendChild(card);
      }

      // Wire up click handlers for the new buttons
      storiesEl.querySelectorAll('.open-issue').forEach(btn => {
        btn.addEventListener('click', () => {
          const n = parseInt(btn.getAttribute('data-number'), 10);
          openIssue(n, { push: true });
        });
      });
    }

    // ---------- CSV export ----------
    function toCSV(items){
      const header = ["number","title","state","updated_iso","labels","role","goal","benefit","consent","context","url"];
      const rows = items.map(i => {
        const p = parseStory(i.body);
        const labels = (i.labels||[]).map(l=>l.name).join('|');
        const clean = s => (s||'').replace(/\r?\n/g,' ').trim();
        return [
          i.number,
          clean(i.title || p.storyLine || ''),
          i.state || '',
          i.updated_at || '',
          labels,
          clean(p.role),
          clean(p.goal),
          clean(p.benefit),
          p.consent || 'N/A',
          clean(p.context),
          i.html_url || ''
        ];
      });
      const escapeCell = v => {
        const s = String(v ?? '');
        return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      };
      const csv = [header.join(','), ...rows.map(r => r.map(escapeCell).join(','))].join('\n');
      return csv;
    }
    function downloadCSV(){
      const csv = toCSV(accumulated);
      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `user-stories_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
    }

    // === NEW: Open/close viewer and render content ===
    async function openIssue(number, {push=false} = {}){
      try{
        setStatus(`Opening #${number}…`);
        drawer.classList.add('open');
        drawer.setAttribute('aria-hidden', 'false');
        detailTitle.textContent = `#${number} Loading…`;
        detailMeta.innerHTML = '';
        detailStory.innerHTML = '';
        detailMarkdown.innerHTML = '';
        detailComments.style.display = 'none';
        detailComments.innerHTML = '';

        if (push){
          const url = new URL(location.href);
          url.searchParams.set('issue', String(number));
          history.pushState({issue:number}, '', url);
        }

        const issue = await fetchIssue(number);

        // Title & GH link
        detailTitle.textContent = issue.title || `Issue #${issue.number}`;
        ghLink.href = issue.html_url || '#';

        // Meta
        const updated = issue.updated_at ? fmtDate(issue.updated_at) : '';
        const labels = (issue.labels||[]).map(l=>l.name).sort();
        const lblHTML = labels.map(n => `<span class="label">${escapeHTML(n)}</span>`).join(' ');
        detailMeta.innerHTML = `
          <div class="meta" style="margin-bottom:.5rem;">
            <span>#${issue.number}</span><span>•</span>
            <span>${escapeHTML(issue.state || '')}</span>
            ${updated ? `<span>•</span><span>Updated ${escapeHTML(updated)}</span>`:''}
          </div>
          ${lblHTML ? `<div class="labels">${lblHTML}</div>`:''}
        `;

        // Extract story parts
        const parsed = parseStory(issue.body || '');
        const consentPill = parsed.consent === 'Yes' ? 'ok' : (parsed.consent === 'No' ? 'no' : 'na');
        detailStory.innerHTML = `
          ${parsed.storyLine ? `<div class="desc" style="margin:.25rem 0  .4rem;">${escapeHTML(parsed.storyLine)}</div>`:''}
          <div class="story-parts" style="margin-bottom:.35rem;">
            ${parsed.role ? `<span class="story-badge">Role: ${escapeHTML(parsed.role)}</span>`:''}
            ${parsed.goal ? `<span class="story-badge">Goal: ${escapeHTML(parsed.goal)}</span>`:''}
            ${parsed.benefit ? `<span class="story-badge">Benefit: ${escapeHTML(parsed.benefit)}</span>`:''}
            <span class="pill ${consentPill}">Consent: ${escapeHTML(parsed.consent || 'N/A')}</span>
          </div>
          ${
            parsed.context
            ? `<div><div class="meta"><strong>Additional context</strong></div>
                <div class="desc" style="white-space:pre-wrap;">${escapeHTML(parsed.context)}</div></div>`
            : ''
          }
        `;

        // Full body (Markdown-rendered)
        detailMarkdown.innerHTML = `
          <h3>Full description</h3>
          ${markdownToHTML(issue.body || '_No description provided._')}
        `;

        setStatus('');
      }catch(err){
        detailTitle.textContent = 'Failed to load';
        detailMarkdown.innerHTML = `<div class="notice">Error: ${escapeHTML(err.message)}</div>`;
        setStatus('');
      }
    }

    function closeIssue({pop=false} = {}){
      drawer.classList.remove('open');
      drawer.setAttribute('aria-hidden', 'true');
      if (!pop){
        const url = new URL(location.href);
        url.searchParams.delete('issue');
        history.pushState({}, '', url);
      }
    }

    // Load comments lazily
    toggleCommentsBtn.addEventListener('click', async ()=>{
      const params = new URLSearchParams(location.search);
      const n = parseInt(params.get('issue') || '0', 10);
      if (!n) return;
      if (detailComments.style.display === 'none'){
        toggleCommentsBtn.textContent = 'Loading…';
        try{
          const comments = await fetchComments(n);
          if (!comments.length){
            detailComments.innerHTML = `<div class="notice">No comments.</div>`;
          }else{
            detailComments.innerHTML = `
              <h3 style="margin-top:0">Comments</h3>
              ${comments.map(c => `
                <div style="border-top:1px solid var(--control-border); padding:.6rem 0;">
                  <div class="meta" style="margin-bottom:.25rem;">
                    <img src="${escapeHTML((c.user||{}).avatar_url||'')}" alt="" style="width:18px; height:18px; border-radius:50%; border:1px solid var(--border)" />
                    <strong>${escapeHTML((c.user||{}).login||'')}</strong>
                    <span>•</span><span>${escapeHTML(fmtDate(c.created_at))}</span>
                  </div>
                  <div class="markdown">${markdownToHTML(c.body || '')}</div>
                </div>
              `).join('')}
            `;
          }
          detailComments.style.display = 'block';
          toggleCommentsBtn.textContent = 'Hide comments';
        }catch(e){
          detailComments.innerHTML = `<div class="notice">Failed to load comments: ${escapeHTML(e.message)}</div>`;
          detailComments.style.display = 'block';
          toggleCommentsBtn.textContent = 'Hide comments';
        }
      }else{
        detailComments.style.display = 'none';
        toggleCommentsBtn.textContent = 'Comments';
      }
    });

    // ---------- Events ----------
    $('#refresh').addEventListener('click', () => {
      currentPage = 1;
      fetchIssues({append:false});
    });
    $('#state').addEventListener('change', () => {
      currentPage = 1;
      fetchIssues({append:false});
    });
    $('#search').addEventListener('input', () => renderIssues(accumulated));
    $('#only-template').addEventListener('change', () => renderIssues(accumulated));

    $('#toggle-token').addEventListener('click', () => {
      const isOpen = tokenBox.style.display !== 'none';
      tokenBox.style.display = isOpen ? 'none' : 'grid';
      $('#toggle-token').setAttribute('aria-expanded', String(!isOpen));
    });
    $('#token').addEventListener('change', (e) => {
      const v = e.target.value.trim();
      if (v) localStorage.setItem('GITHUB_TOKEN', v);
    });

    $('#export').addEventListener('click', downloadCSV);
    $('#print').addEventListener('click', () => window.print());
    moreBtn.addEventListener('click', () => {
      currentPage += 1;
      fetchIssues({append:true});
    });

    // Modal open/close
    openModalBtn.addEventListener('click', () => { backdrop.style.display = 'flex'; });
    cancelModalBtn.addEventListener('click', () => { backdrop.style.display = 'none'; });
    backdrop.addEventListener('click', (e) => { if (e.target === backdrop) backdrop.style.display = 'none'; });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape'){
        if (drawer.classList.contains('open')) closeIssue();
        else backdrop.style.display = 'none';
      }
    });

    // Create story -> GitHub Issue
    storyForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = $('#title').value.trim();
      const role = $('#role').value.trim();
      const goal = $('#goal').value.trim();
      const benefit = $('#benefit').value.trim();

      if (!title) { alert('Title is required'); return; }
      if (!role || !goal) { alert('Please provide at least the role and the goal.'); return; }

      const payload = {
        title,
        role,
        goal,
        benefit,
        context: $('#context').value.trim(),
        consent: $('#consent').value,
        labels: $('#labels').value.trim(),
        assignees: $('#assignees').value.trim()
      };

      try {
        setStatus('Creating issue… ');
        const issue = await createIssue(payload);
        setStatus('Issue created successfully.');
        backdrop.style.display = 'none';

        // Clear the form and re-render
        storyForm.reset();
        $('#labels').value = 'user-story';
        accumulated = [issue, ...accumulated];
        renderIssues(accumulated);

        // Open the new issue directly in the drawer
        openIssue(issue.number, { push: true });
      } catch (err) {
        alert('Failed to create issue: ' + err.message);
        setStatus('');
      }
    });

    // NEW: Drawer close button
    detailCloseBtn.addEventListener('click', () => closeIssue());

    // ---------- Routing ----------
    window.addEventListener('popstate', () => {
      const params = new URLSearchParams(location.search);
      const issue = params.get('issue');
      if (issue){
        openIssue(parseInt(issue,10), { push:false });
      }else{
        // Close if no issue in URL
        if (drawer.classList.contains('open')) closeIssue({pop:true});
      }
    });

    // ---------- Build issue body for creation ----------
    function buildIssueBody({role, goal, benefit, context, consent}) {
      const line = (role || goal || benefit)
        ? `As a ${role || '_____'}, I want to ${goal || '______'}, so that I can ${benefit || '________'}.`
        : '';
      return [
        'User Story',
        '',
        '**User story description, please follow the syntax below**',
        line,
        '',
        '**Additional context**',
        context || '',
        '',
        '**Can we contact you to participate in a future EOSC funded project on FAIR data management?**',
        (consent || 'N/A')
      ].join('\n');
    }

    async function createIssue({
      title, role, goal, benefit, context, consent, labels, assignees
    }) {
      const token = localStorage.getItem('GITHUB_TOKEN') || tokenInput.value.trim();
      if (!token) throw new Error('Missing token. Set Token in the header.');

      const headers = {
        'Accept': 'application/vnd.github+json',
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      };

      const body = {
        title: title.trim(),
        body: buildIssueBody({role, goal, benefit, context, consent}),
        labels: (labels || 'user-story').split(',').map(s => s.trim()).filter(Boolean),
        assignees: (assignees || '').split(',').map(s => s.trim()).filter(Boolean)
      };

      const url = `https://api.github.com/repos/${encodeURIComponent(OWNER)}/${encodeURIComponent(REPO)}/issues`;
      const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body) });
      updateRateFromHeaders(res.headers);
      if (!res.ok) {
        if(res.status === 401) throw new Error('401 Unauthorized — check your token');
        if(res.status === 403) throw new Error('403 Forbidden or rate-limited — verify scopes or wait');
        if(res.status === 410) throw new Error('410 Gone — issues disabled in this repository');
        const text = await res.text();
        throw new Error(`${res.status} ${res.statusText} — ${text}`);
      }
      return res.json();
    }

    // ---------- Init ----------
    (function init(){
      const saved = localStorage.getItem('GITHUB_TOKEN');
      if (saved) tokenInput.value = '••••••••••••••••';
      currentPage = 1;
      fetchIssues({append:false}).then(() => {
        // If deep link present, open it
        const params = new URLSearchParams(location.search);
        const issue = params.get('issue');
        if (issue) openIssue(parseInt(issue,10), { push:false });
      });
    })();
  </script>
</body>
</html>
