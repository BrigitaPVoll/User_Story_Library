<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>User Story Library ¬∑ DeiC</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
/* ============================================================
   THEME ‚Äî DeiC Light + Dark (darker light, readable dark)
============================================================ */
:root{
  --deic-green:#BFD730;
  --deic-blue:#16385D;

  /* Light theme, slightly darker for contrast */
  --bg:#EEF2EC;
  --card:#FFFFFF;
  --border:#C9D3C2;

  --text:#14180F;
  --muted:#596368;

  --chip-bg:#E6EEDA;
  --chip-selected:#BFD730;
  --chip-selected-text:#000;

  --radius:14px;
  --shadow:0 4px 15px rgba(0,0,0,.10);
  --shadow-hover:0 10px 28px rgba(0,0,0,.14);
}
.dark{
  /* Dark mode tuned for readability */
  --bg:#0C1420;
  --card:#182234;           /* brighter than before */
  --border:#2E3B52;
  --text:#ECF2FA;           /* brighter text */
  --muted:#AAB6C6;

  --chip-bg:#233149;        /* readable chip base */
  --chip-selected:#BFD730;  /* same lime */
  --chip-selected-text:#000;
}

/* ============================================================
   BASE
============================================================ */
*{box-sizing:border-box}
body{
  margin:0; font-family:Inter,ui-sans-serif,system-ui;
  background:var(--bg); color:var(--text);
  transition:background .25s, color .25s;
}
.wrap{max-width:1100px;margin:0 auto;padding:0 1.25rem}
a{color:var(--deic-blue);text-decoration:none}
a:hover{text-decoration:underline}

/* ============================================================
   HEADER
============================================================ */
header{
  position:sticky;top:0;z-index:20;
  background:#fffffff0;
  backdrop-filter:blur(12px);
  border-bottom:3px solid var(--deic-green);
  box-shadow:var(--shadow);
}
.dark header{background:#131A28DD}
.header-row{
  display:flex;justify-content:space-between;align-items:center;
  padding:1rem 0;gap:1rem;flex-wrap:wrap;
}
.brand{display:flex;align-items:center;gap:.75rem}
.logo{
  width:42px;height:42px;border-radius:12px;
  background:conic-gradient(from 180deg,var(--deic-green),var(--deic-blue),#000,var(--deic-green));
  border:1px solid var(--border);box-shadow:var(--shadow);
}
h1{margin:0;font-size:1.6rem;font-weight:800;color:var(--deic-blue)}
.dark h1{color:var(--deic-green)}
.tagline{margin:.15rem 0 0;color:var(--muted)}

/* Buttons */
.btn{
  padding:.65rem 1rem;border:none;border-radius:var(--radius);
  font-weight:600;cursor:pointer;transition:.15s;
}
.btn-primary{background:var(--deic-green);color:#000}
.btn-primary:hover{filter:brightness(1.07)}
.btn-secondary{background:var(--deic-blue);color:#fff}
.btn-secondary:hover{filter:brightness(1.07)}
.btn-ghost{
  background:var(--card);border:1px solid var(--border);color:var(--text);
}
.btn-ghost:hover{background:var(--chip-bg)}

/* ============================================================
   FILTER BAR
============================================================ */
.filters{
  margin-top:1rem;background:var(--card);
  border:1px solid var(--border);border-radius:var(--radius);
  padding:1rem;box-shadow:var(--shadow);
}
.filter-top{
  display:grid;grid-template-columns:1fr auto auto auto;gap:.6rem;
}
@media (max-width:900px){ .filter-top{grid-template-columns:1fr 1fr 1fr} }
@media (max-width:640px){ .filter-top{grid-template-columns:1fr 1fr} }
input,select{
  padding:.65rem .75rem;border-radius:var(--radius);
  border:1px solid var(--border);background:var(--card);color:var(--text);
}

/* Facets (expand/collapse) */
.facets{margin-top:1rem;display:flex;flex-direction:column;gap:1rem}
.facet{
  border:1px solid var(--border);
  border-radius:var(--radius);
  background:var(--card);
}
.facet-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:.6rem .8rem;cursor:pointer;
}
.facet-title{margin:0;font-weight:700;font-size:.95rem;color:var(--muted)}
.chevron{
  width:.65rem;height:.65rem;transform:rotate(-45deg);
  border-right:2px solid var(--muted);border-bottom:2px solid var(--muted);
  transition:transform .2s ease;
}
.facet.collapsed .chevron{transform:rotate(135deg)}
.facet-body{overflow:hidden;transition:max-height .25s ease;max-height:500px;padding:0 .8rem .8rem}
.facet.collapsed .facet-body{max-height:0;padding-bottom:0}

.chip-row{display:flex;flex-wrap:wrap;gap:.45rem;margin-top:.5rem}
.chip{
  padding:.35rem .7rem;border-radius:999px;
  background:var(--chip-bg);border:1px solid var(--border);
  cursor:pointer;font-size:.82rem;transition:background .15s;
}
.chip.selected{
  background:var(--chip-selected);
  border-color:var(--chip-selected);
  color:var(--chip-selected-text);
}

/* ============================================================
   GRID / CARDS
============================================================ */
.grid{margin-top:1.5rem;display:grid;gap:1.25rem;grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
.card{
  background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
  padding:1.25rem;box-shadow:var(--shadow);cursor:pointer;transition:.2s;
}
.card:hover{transform:translateY(-3px);box-shadow:var(--shadow-hover);border-color:var(--deic-green)}
.card-title{font-size:1.1rem;font-weight:700;margin-bottom:.5rem}
.meta{font-size:.85rem;color:var(--muted);margin-bottom:.6rem}
.labels{display:flex;flex-wrap:wrap;gap:.35rem}
.label{
  padding:.2rem .55rem;border-radius:999px;background:#E9F1D8;
  border:1px solid var(--border);font-size:.75rem;color:#213014
}
.dark .label{background:#283752;color:#E9EFF8}

/* Pagination */
.pagination{margin:2rem 0;display:flex;gap:.5rem;justify-content:center;align-items:center}
.page-btn{padding:.5rem .9rem;border-radius:var(--radius);background:var(--card);border:1px solid var(--border);cursor:pointer}
.page-btn:hover{background:var(--chip-bg)}
.page-info{color:var(--muted);font-size:.9rem}

/* ============================================================
   BOTTOM-SHEET PREVIEW
============================================================ */
#sheet-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:90}
#sheet{
  position:fixed;left:0;right:0;bottom:-100%;
  background:var(--card);border-radius:24px 24px 0 0;box-shadow:0 -10px 28px rgba(0,0,0,.28);
  padding:1.5rem;max-height:85vh;overflow-y:auto;z-index:100;transition:bottom .35s cubic-bezier(.25,.8,.25,1);
}
#sheet.open{bottom:0}
.sheet-header{display:flex;justify-content:space-between;align-items:center}
.sheet-title{margin:0;font-size:1.25rem;font-weight:800}
.sheet-close{background:var(--card);border:1px solid var(--border);padding:.45rem .8rem;border-radius:var(--radius);cursor:pointer}
.sheet-content pre{
  white-space:pre-wrap;padding:1rem;border-radius:var(--radius);border:1px solid var(--border);
  background:var(--card);color:var(--text); /* ensure readable in dark mode */
}

/* ============================================================
   MODAL (Create Story) ‚Äî NO assignees, NO token field
============================================================ */
#modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:200}
#modal{
  width:min(680px,92vw);background:var(--card);border:2px solid var(--deic-green);
  border-radius:var(--radius);padding:1.5rem;box-shadow:0 10px 40px rgba(0,0,0,.3)
}
.modal-title{margin:0 0 .75rem;font-size:1.25rem;font-weight:800;color:var(--deic-blue)}
.dark .modal-title{color:var(--deic-green)}
.modal-grid{display:grid;gap:1rem;grid-template-columns:1fr 1fr}
.modal-grid .full{grid-column:1/-1}
textarea{min-height:110px;resize:vertical;padding:.75rem;border:1px solid var(--border);border-radius:var(--radius)}
.hint{font-size:.85rem;color:var(--muted);margin-top:.6rem}

</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="header-row">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>User Story Library</h1>
          <p class="tagline">FAIR use cases integrated with GitHub Issues</p>
        </div>
      </div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button id="openModal" class="btn btn-primary">New Story</button>
        <button id="exportCsv" class="btn btn-secondary">CSV</button>
        <button id="printPdf" class="btn btn-secondary">Print/PDF</button>
        <label class="switch"><input id="darkToggle" type="checkbox"><span>üåô</span></label>
      </div>
    </div>

    <!-- Filters bar -->
    <div class="filters">
      <div class="filter-top">
        <input id="search" placeholder="Search‚Ä¶"/>
        <select id="sort">
          <option value="newest">Newest first</option>
          <option value="oldest">Oldest first</option>
        </select>
        <button id="refresh" class="btn btn-primary">Refresh</button>
        <button id="clearFilters" class="btn btn-ghost">Clear filters</button>
      </div>

      <!-- Faceted filters -->
      <div class="facets">

        <div class="facet" data-facet="consent">
          <div class="facet-header">
            <h3 class="facet-title">Contact Consent</h3>
            <span class="chevron"></span>
          </div>
          <div class="facet-body">
            <div id="facetConsent" class="chip-row"></div>
          </div>
        </div>

        <div class="facet collapsed" data-facet="domain">
          <div class="facet-header">
            <h3 class="facet-title">Domain</h3>
            <span class="chevron"></span>
          </div>
          <div class="facet-body">
            <div id="facetDomain" class="chip-row"></div>
          </div>
        </div>

        <div class="facet collapsed" data-facet="institution">
          <div class="facet-header">
            <h3 class="facet-title">Institution</h3>
            <span class="chevron"></span>
          </div>
          <div class="facet-body">
            <div id="facetInstitution" class="chip-row"></div>
          </div>
        </div>

      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <section id="storyGrid" class="grid"></section>
  <div id="empty" style="display:none;text-align:center;padding:2rem;color:var(--muted)">No user stories found.</div>

  <div class="pagination">
    <button id="prevPage" class="page-btn">Previous</button>
    <span id="pageInfo" class="page-info"></span>
    <button id="nextPage" class="page-btn">Next</button>
  </div>
</div>

<!-- Bottom-sheet preview -->
<div id="sheet-backdrop"></div>
<div id="sheet">
  <div class="sheet-header">
    <h3 id="sheetTitle" class="sheet-title">Loading‚Ä¶</h3>
    <button id="sheetClose" class="sheet-close">Close</button>
  </div>
  <div id="sheetContent" class="sheet-content"></div>
</div>

<!-- Create Story Modal (NO assignees, NO token field) -->
<div id="modal-backdrop">
  <div id="modal">
    <h3 class="modal-title">Create New User Story</h3>
    <form id="storyForm">
      <div class="modal-grid">
        <div class="full">
          <label>Title</label>
          <input id="titleInput" placeholder='User Story: ' required />
        </div>
        <div>
          <label>As a‚Ä¶</label>
          <input id="roleInput" placeholder="e.g., researcher, data steward"/>
        </div>
        <div>
          <label>I want to‚Ä¶</label>
          <input id="goalInput" placeholder="action you want to perform"/>
        </div>
        <div class="full">
          <label>‚Ä¶so that I can‚Ä¶</label>
          <input id="benefitInput" placeholder="the outcome/benefit"/>
        </div>
        <div class="full">
          <label>Additional context</label>
          <textarea id="contextInput" placeholder="data sources, domain, workflows, constraints‚Ä¶"></textarea>
        </div>
        <div class="full">
          <label>Contact consent</label>
          <select id="consentInput">
            <option value="Yes">Yes</option>
            <option value="No">No</option>
            <option value="N/A" selected>N/A</option>
          </select>
        </div>
        <div class="full">
          <label>Labels (comma; default keeps ‚Äúuser-story‚Äù)</label>
          <input id="labelsInput" value="user-story"/>
        </div>
      </div>
      <div class="hint">
        To create issues, ensure a token exists in <code>localStorage</code>:<br/>
        <code>localStorage.setItem('GITHUB_TOKEN','ghp_‚Ä¶')</code>
      </div>
      <div style="text-align:right;margin-top:1rem">
        <button type="button" id="cancelModal" class="btn btn-secondary">Cancel</button>
        <button type="submit" class="btn btn-primary">Create</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ============================================================
   CONFIG
============================================================ */
const OWNER="BrigitaPVoll";
const REPO ="User_Story_Library";
const PER_PAGE=20;

const LABELS = [
  "Contact consent>NO","Contact consent>YES",
  "Domain>Agricultural Sciences","Domain>Domain agnostic","Domain>Engineering and Technology",
  "Domain>Humanities","Domain>Medical and Health Sciences","Domain>Natural Sciences","Domain>Social Sciences",
  "Institution>Aalborg University","Institution>Aarhus University","Institution>Copenhagen Business School (CBS)",
  "Institution>IT University of Copenhagen","Institution>Roskilde University",
  "Institution>Technical University of Denmark (DTU)",
  "Institution>University of Copenhagen","Institution>University of Southern Denmark (SDU)"
];

/* Create facet sets and sort alphabetically by the label suffix */
const FACETS = {
  consent: ["Contact consent>NO","Contact consent>YES"].sort((a,b)=>a.localeCompare(b)),
  domain : LABELS.filter(x=>x.startsWith("Domain>"))
                 .sort((a,b)=>a.split(">")[1].localeCompare(b.split(">")[1])),
  inst   : LABELS.filter(x=>x.startsWith("Institution>"))
                 .sort((a,b)=>a.split(">")[1].localeCompare(b.split(">")[1]))
};

const $ = s => document.querySelector(s);
function esc(s){ return String(s||"").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

let issues=[], filtered=[], page=1, activeChips=new Set();

/* ============================================================
   DARK MODE
============================================================ */
const darkToggle=$("#darkToggle");
if(localStorage.getItem("darkMode")==="true"){ document.body.classList.add("dark"); darkToggle.checked=true; }
darkToggle.onchange=()=>{ document.body.classList.toggle("dark"); localStorage.setItem("darkMode",document.body.classList.contains("dark")); };

/* ============================================================
   FACETS (build + collapse)
============================================================ */
function chipLabel(label){
  if(label.startsWith("Domain>")||label.startsWith("Institution>")) return label.split(">")[1].trim();
  if(label.startsWith("Contact consent>")) return label.split(">")[1].trim();
  return label;
}
function buildFacet(container, list){
  const box=$(container);
  box.innerHTML="";
  list.forEach(L=>{
    const chip=document.createElement("div");
    chip.className="chip";
    chip.dataset.value=L;                 // full label used for filtering
    chip.textContent=chipLabel(L);        // display suffix only for readability
    chip.onclick=()=>{
      const v=chip.dataset.value;
      if(activeChips.has(v)) activeChips.delete(v);
      else activeChips.add(v);
      chip.classList.toggle("selected");
      applyFilters();
    };
    box.appendChild(chip);
  });
}
function initFacets(){
  buildFacet("#facetConsent",    FACETS.consent);
  buildFacet("#facetDomain",     FACETS.domain);
  buildFacet("#facetInstitution",FACETS.inst);

  // Collapse/expand behavior
  document.querySelectorAll(".facet").forEach(f=>{
    const header=f.querySelector(".facet-header");
    header.addEventListener("click", ()=> f.classList.toggle("collapsed"));
  });
}

/* Clear all filters */
function clearFilters(){
  activeChips.clear();
  document.querySelectorAll(".chip.selected").forEach(c=>c.classList.remove("selected"));
  $("#search").value="";
  $("#sort").value="newest";
  page=1;
  applyFilters();
}

/* ============================================================
   LOAD ISSUES (state=all)
============================================================ */
async function loadIssues(){
  const res=await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/issues?state=all&per_page=100`,
                        {headers:{"Accept":"application/vnd.github+json"}});
  const data=await res.json();
  issues=(data||[]).filter(x=>!x.pull_request);

  // for display, sort card labels alphabetically by name
  issues.forEach(i=>{
    if(i.labels) i.labels.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
  });

  applyFilters();
}

/* ============================================================
   FILTER + SORT + PAGINATE
============================================================ */
function applyFilters(){
  const q=($("#search").value||"").toLowerCase();
  const sort=$("#sort").value;

  filtered=issues.filter(it=>{
    if(q){
      const hay=`${it.title||""} ${it.body||""}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
    if(activeChips.size>0){
      const names=(it.labels||[]).map(l=>l.name);
      for(const lab of activeChips){ if(!names.includes(lab)) return false; }
    }
    return true;
  });

  filtered.sort((a,b)=>{
    if(sort==="newest") return new Date(b.created_at)-new Date(a.created_at);
    return new Date(a.created_at)-new Date(b.created_at);
  });

  page=1;
  renderPage();
}

function renderPage(){
  const grid=$("#storyGrid");
  grid.innerHTML="";

  const start=(page-1)*PER_PAGE;
  const end=start+PER_PAGE;
  const slice=filtered.slice(start,end);

  if(slice.length===0){
    $("#empty").style.display="block";
    $("#pageInfo").textContent="";
    $("#prevPage").disabled=true; $("#nextPage").disabled=true;
    return;
  }
  $("#empty").style.display="none";

  slice.forEach(it=>{
    const labelsHTML=(it.labels||[]).map(l=>`<span class="label">${esc(l.name)}</span>`).join("");

    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div class="card-title">${esc(it.title)}</div>
      <div class="meta">#${it.number} ¬∑ ${esc(it.state)} ¬∑ ${new Date(it.updated_at).toLocaleString()}</div>
      <div class="labels">${labelsHTML}</div>
    `;
    card.onclick=()=>openSheet(it.number);
    grid.appendChild(card);
  });

  const pages=Math.max(1,Math.ceil(filtered.length/PER_PAGE));
  $("#pageInfo").textContent=`Page ${page} / ${pages}`;
  $("#prevPage").disabled=(page===1);
  $("#nextPage").disabled=(page>=pages);
}

/* Pagination buttons */
$("#prevPage").onclick=()=>{ if(page>1){page--;renderPage();} };
$("#nextPage").onclick=()=>{ const pages=Math.ceil(filtered.length/PER_PAGE); if(page<pages){page++;renderPage();} };

/* ============================================================
   BOTTOM-SHEET PREVIEW
============================================================ */
async function openSheet(number){
  $("#sheet-backdrop").style.display="block";
  $("#sheet").classList.add("open");
  $("#sheetTitle").textContent=`#${number} ‚Äî Loading‚Ä¶`;
  $("#sheetContent").innerHTML="";

  const res=await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/issues/${number}`, {headers:{"Accept":"application/vnd.github+json"}});
  const it=await res.json();

  const labelsHTML=(it.labels||[]).map(l=>`<span class="label">${esc(l.name)}</span>`).join("");

  $("#sheetTitle").textContent=it.title || `Issue #${it.number}`;
  $("#sheetContent").innerHTML=`
    <div><strong>ID:</strong> #${it.number}</div>
    <div><strong>Status:</strong> ${esc(it.state||"")}</div>
    <div><strong>Updated:</strong> ${new Date(it.updated_at).toLocaleString()}</div>

    <hr style="margin:1rem 0">

    <pre>${esc(it.body||"")}</pre>

    <div style="margin-top:1rem"><strong>Labels:</strong><br>${labelsHTML||"<span class='meta'>No labels</span>"}</div>

    <div style="margin-top:1rem">
      <a href="${it.html_url}" target="_blank" rel="noopener">Open on GitHub ‚Üó</a>
    </div>
  `;
}
function closeSheet(){ $("#sheet-backdrop").style.display="none"; $("#sheet").classList.remove("open"); }
$("#sheet-backdrop").onclick=closeSheet; $("#sheetClose").onclick=closeSheet;

/* ============================================================
   CREATE STORY ‚Äî NO assignees/token fields; token via localStorage
============================================================ */
$("#openModal").onclick=()=>$("#modal-backdrop").style.display="flex";
$("#cancelModal").onclick=()=>$("#modal-backdrop").style.display="none";

$("#storyForm").onsubmit=async(e)=>{
  e.preventDefault();

  const token=localStorage.getItem("GITHUB_TOKEN");
  if(!token){ alert("To create issues, set a token in localStorage:\nlocalStorage.setItem('GITHUB_TOKEN','ghp_‚Ä¶')"); return; }

  const title   = ($("#titleInput").value || "User Story: ").trim();
  const role    = $("#roleInput").value.trim();
  const goal    = $("#goalInput").value.trim();
  const benefit = $("#benefitInput").value.trim();
  const context = $("#contextInput").value.trim();
  const consent = $("#consentInput").value;
  const labels  = ($("#labelsInput").value || "user-story").split(",").map(x=>x.trim()).filter(Boolean);
  if(!labels.includes("user-story")) labels.unshift("user-story");

  /* Issue body using your exact template (front-matter + sections) */
  const body = [
'---',
'name: User Story',
'about: A FAIR use case describing who needs what data, for what purpose, and under what conditions.',
'title: "User Story: "',
'labels: ["user-story"]',
'assignees: ""',
'---',
'',
'## üß© User story',
'',
'Please follow the standard user‚Äëstory syntax.',
'',
'**As a**',
(role || '‚Ä¶'),
'',
'**I want to**',
(goal || '‚Ä¶'),
'',
'**So that I can**',
(benefit || '‚Ä¶'),
'',
'---',
'',
'## üìå Additional context',
'',
(context || '‚Ä¶'),
'',
'---',
'',
'## üì¨ Contact for future EOSC‚Äëfunded FAIR projects',
'',
'Can we contact you to participate in a future EOSC‚Äëfunded project on FAIR data management?',
'',
(consent==="Yes" ? '- [x] **Yes**\n- [ ] **No**' :
 consent==="No"  ? '- [ ] **Yes**\n- [x] **No**' :
                    '- [ ] **Yes**\n- [ ] **No**'),
'',
'<!--',
'If yes, please leave your preferred contact details in a comment',
'(e.g. email or GitHub username).',
'-->'
  ].join('\n');

  const res=await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/issues`,{
    method:"POST",
    headers:{
      "Accept":"application/vnd.github+json",
      "Authorization":"Bearer "+token,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({title,body,labels})
  });

  if(!res.ok){ alert("Failed to create issue: "+(await res.text())); return; }

  alert("Story created!");
  $("#modal-backdrop").style.display="none";
  loadIssues();
};

/* ============================================================
   CSV + PRINT
============================================================ */
$("#exportCsv").onclick=()=>{
  const rows=[["number","title","state","updated","labels","body"]];
  issues.forEach(i=>{
    const labels=(i.labels||[]).map(l=>l.name).sort().join("|").replace(/"/g,'""');
    const body=(i.body||"").replace(/"/g,'""');
    rows.push([
      i.number,(i.title||"").replace(/"/g,'""'),i.state||"",i.updated_at||"",
      labels,body
    ].map(v=>/[,\"\n]/.test(v)?`"${v}"`:v).join(","));
  });
  const blob=new Blob([rows.join("\n")],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);a.download="user_stories.csv";a.click();
};
$("#printPdf").onclick=()=>window.print();

/* ============================================================
   EVENTS + INIT
============================================================ */
$("#search").oninput=applyFilters;
$("#sort").onchange=applyFilters;
$("#refresh").onclick=loadIssues;
$("#clearFilters").onclick=clearFilters;

initFacets();
loadIssues();
</script>
</body>
</html>