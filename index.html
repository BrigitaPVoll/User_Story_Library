<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>User Story Library Â· DeiC</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>

/* ============================================================
   THEME VARIABLES â€” LIGHT + DARK
============================================================ */
:root {
  --deic-green: #BFD730;
  --deic-blue: #16385D;

  --bg: #F7F9F7;
  --card: #FFFFFF;
  --border: #DDE5D7;

  --text: #1B1F14;
  --muted: #667085;

  --radius: 14px;
  --shadow: 0 4px 15px rgba(0,0,0,.08);
  --shadow-hover: 0 8px 24px rgba(0,0,0,.12);

  --chip-bg: #EFF6D9;
  --chip-selected-bg: var(--deic-green);
  --chip-selected-text: #000;
}

.dark {
  --bg: #0E1523;
  --card: #151E2A;
  --border: #2C3A4D;
  --text: #E5EAF2;
  --muted: #9AA4B6;
  --chip-bg: #243044;
  --chip-selected-bg: var(--deic-green);
  --chip-selected-text: #000;
}

/* ============================================================
   BASE
============================================================ */
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: Inter, ui-sans-serif, system-ui;
  background: var(--bg);
  color: var(--text);
  transition: background .25s, color .25s;
}
a { color: var(--deic-blue); text-decoration: none; }
a:hover { text-decoration: underline; }

.wrap { max-width: 1100px; margin: 0 auto; padding: 0 1.25rem; }

/* ============================================================
   HEADER
============================================================ */
header {
  position: sticky; top: 0; z-index: 20;
  background: rgba(255,255,255,.96);
  backdrop-filter: blur(12px);
  border-bottom: 3px solid var(--deic-green);
  box-shadow: var(--shadow);
}
.dark header { background: rgba(20,26,40,.85); }

.header-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 1rem 0; flex-wrap: wrap; gap: 1rem;
}

.brand { display: flex; align-items: center; gap: .75rem; }
.logo {
  width: 42px; height: 42px; border-radius: 12px;
  background: conic-gradient(from 180deg,var(--deic-green),var(--deic-blue),#000,var(--deic-green));
  border: 1px solid var(--border); box-shadow: var(--shadow);
}
h1 { margin: 0; font-size: 1.6rem; font-weight: 800; color: var(--deic-blue); }
.dark h1 { color: var(--deic-green); }
.tagline { margin: .2rem 0 0; color: var(--muted); max-width: 650px; }

/* ============================================================
   BUTTONS
============================================================ */
.btn {
  padding:.65rem 1rem; border-radius: var(--radius); border:none;
  font-weight:600; cursor:pointer; transition:.15s;
}
.btn-primary { background: var(--deic-green); color:#000; }
.btn-primary:hover { filter: brightness(1.1); }
.btn-secondary { background: var(--deic-blue); color:white; }
.btn-secondary:hover { filter: brightness(1.1); }

/* ============================================================
   FILTERS + SORT + DARK MODE
============================================================ */
.filters {
  margin-top: 1rem;
  background: var(--card);
  border: 1px solid var(--border);
  padding: 1rem;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}

.filter-top {
  display:flex; gap:1rem; flex-wrap:wrap;
  align-items:center; justify-content:space-between;
}

input, select {
  padding:.65rem .75rem;
  border-radius:var(--radius);
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
}

/* ============================================================
   LABEL CHIPS (MULTI-SELECT)
============================================================ */
.chip-row {
  margin-top:1rem;
  display:flex; flex-wrap:wrap;
  gap:.5rem;
}
.chip {
  padding:.35rem .75rem;
  font-size:.85rem;
  background: var(--chip-bg);
  border:1px solid var(--border);
  border-radius:999px;
  cursor:pointer;
  transition: background .15s;
}
.chip.selected {
  background: var(--chip-selected-bg);
  color: var(--chip-selected-text);
  border-color: var(--chip-selected-bg);
}

/* ============================================================
   GRID OF USE CASES
============================================================ */
.grid {
  margin-top:1.5rem;
  display:grid;
  gap:1.25rem;
  grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
}

.card {
  background: var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:1.25rem;
  box-shadow:var(--shadow);
  cursor:pointer;
  transition:.2s ease;
}
.card:hover { transform:translateY(-3px); box-shadow:var(--shadow-hover); }

.card-title { font-size:1.1rem; font-weight:700; margin-bottom:.5rem; }
.meta { font-size:.85rem; color:var(--muted); margin-bottom:.6rem; }
.labels { display:flex; flex-wrap:wrap; gap:.35rem; }
.label {
  background:#EFF6D9; padding:.2rem .55rem; border-radius:999px;
  border:1px solid var(--border); font-size:.75rem; color:#1F2A14;
}
.dark .label { background:#243044; color:#E5EAF2; }

/* ============================================================
   PAGINATION
============================================================ */
.pagination {
  margin:2rem 0; display:flex; gap:.5rem;
  justify-content:center; align-items:center;
}
.page-btn {
  padding:.5rem .9rem; border-radius:var(--radius);
  background:var(--card); border:1px solid var(--border);
  cursor:pointer;
}
.page-btn:hover { background:var(--chip-bg); }
.page-info { font-size:.9rem; color:var(--muted); }

/* ============================================================
   DARK-MODE SWITCH
============================================================ */
.switch {
  display:flex; align-items:center; gap:.4rem; cursor:pointer;
}
.switch input { cursor:pointer; }

/* ============================================================
   BOTTOM-SHEET PREVIEW
============================================================ */
#sheet-backdrop {
  position:fixed; inset:0;
  background:rgba(0,0,0,.3);
  display:none;
  z-index:90;
}
#sheet {
  position:fixed;
  left:0; right:0; bottom:-100%;
  background:var(--card);
  border-radius:24px 24px 0 0;
  padding:1.5rem;
  max-height:85vh;
  overflow-y:auto;
  box-shadow:0 -8px 25px rgba(0,0,0,.25);
  z-index:100;
  transition:bottom .35s cubic-bezier(.25,.8,.25,1);
}
#sheet.open { bottom:0; }

.sheet-header {
  display:flex; justify-content:space-between; align-items:center;
}
.sheet-title { font-size:1.25rem; font-weight:800; }
.sheet-close {
  background:var(--card); border:1px solid var(--border);
  padding:.45rem .8rem; border-radius:var(--radius);
  cursor:pointer;
}

</style>
</head>
<body>

<!-- ============================================================
     HEADER
============================================================ -->
<header>
  <div class="wrap">
    <div class="header-row">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>User Story Library</h1>
          <p class="tagline">FAIR use cases integrated with GitHub Issues</p>
        </div>
      </div>

      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button id="openNew" class="btn btn-primary">New Story</button>
        <button id="exportCsv" class="btn btn-secondary">CSV</button>
        <button id="printPdf" class="btn btn-secondary">Print / PDF</button>

        <!-- DARK MODE -->
        <label class="switch">
          <input id="darkToggle" type="checkbox">
          <span>ðŸŒ™</span>
        </label>
      </div>
    </div>

    <!-- FILTERS -->
    <div class="filters">

      <div class="filter-top">
        <input id="search" placeholder="Searchâ€¦"/>

        <select id="sort">
          <option value="newest">Newest first</option>
          <option value="oldest">Oldest first</option>
        </select>

        <button id="refresh" class="btn btn-primary">Refresh</button>
      </div>

      <!-- LABEL CHIPS (ALL 17) -->
      <div id="chipRow" class="chip-row"></div>
    </div>

  </div>
</header>

<!-- ============================================================
     USE CASE GRID
============================================================ -->
<div class="wrap">
  <section id="storyGrid" class="grid"></section>

  <div id="empty" style="display:none;color:var(--muted);text-align:center;padding:2rem">
    No user stories found.
  </div>

  <!-- PAGINATION -->
  <div class="pagination">
    <button id="prevPage" class="page-btn">Previous</button>
    <span id="pageInfo" class="page-info"></span>
    <button id="nextPage" class="page-btn">Next</button>
  </div>
</div>

<!-- ============================================================
     BOTTOM SHEET PREVIEW
============================================================ -->
<div id="sheet-backdrop"></div>
<div id="sheet">
  <div class="sheet-header">
    <h3 id="sheetTitle" class="sheet-title">Loadingâ€¦</h3>
    <button id="sheetClose" class="sheet-close">Close</button>
  </div>
  <div id="sheetContent"></div>
</div>

<script>
/* ============================================================
   CONFIG
============================================================ */
const OWNER = "BrigitaPVoll";
const REPO  = "User_Story_Library";
const PER_PAGE = 20;

const STATIC_LABELS = [
  "Contact consent>NO","Contact consent>YES",
  "Domain>Agricultural Sciences","Domain>Domain agnostic","Domain>Engineering and Technology",
  "Domain>Humanities","Domain>Medical and Health Sciences","Domain>Natural Sciences","Domain>Social Sciences",
  "Institution>Aalborg University","Institution>Aarhus University","Institution>Copenhagen Business School (CBS)",
  "Institution>IT University of Copenhagen","Institution>Roskilde University",
  "Institution>Technical University of Denmark (DTU)",
  "Institution>University of Copenhagen","Institution>University of Southern Denmark (SDU)"
];

const $ = s => document.querySelector(s);

let issues = [];
let filtered = [];
let page = 1;

/* ============================================================
   DARK MODE
============================================================ */
const toggleDark = $("#darkToggle");
if(localStorage.getItem("darkMode")==="true"){
  document.body.classList.add("dark");
  toggleDark.checked = true;
}
toggleDark.onchange = ()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("darkMode", document.body.classList.contains("dark"));
};

/* ============================================================
   CHIP FILTER SETUP
============================================================ */
let activeChips = new Set();

function renderChips(){
  const row = $("#chipRow");
  row.innerHTML = "";
  STATIC_LABELS.forEach(label=>{
    const chip = document.createElement("div");
    chip.className="chip";
    chip.textContent = label;
    chip.onclick = ()=>{
      if(activeChips.has(label)) activeChips.delete(label);
      else activeChips.add(label);
      chip.classList.toggle("selected");
      applyFilters();
    };
    row.appendChild(chip);
  });
}

/* ============================================================
   FETCH ISSUES
============================================================ */
async function loadIssues(){
  const res = await fetch(
    `https://api.github.com/repos/${OWNER}/${REPO}/issues?state=all&per_page=100`
  );
  const data = await res.json();
  issues = data.filter(x=>!x.pull_request);
  applyFilters();
}

/* ============================================================
   FILTER + SORT + PAGINATE
============================================================ */
function applyFilters(){
  const q = ($("#search").value||"").toLowerCase();
  const sort = $("#sort").value;

  filtered = issues.filter(it=>{
    // Text search
    const hay = `${it.title} ${it.body}`.toLowerCase();
    if(q && !hay.includes(q)) return false;

    // Chips filter
    if(activeChips.size>0){
      const names = (it.labels||[]).map(l=>l.name);
      for(const chip of activeChips){
        if(!names.includes(chip)) return false;
      }
    }
    return true;
  });

  // Sorting
  filtered.sort((a,b)=>{
    if(sort==="newest") return new Date(b.created_at)-new Date(a.created_at);
    return new Date(a.created_at)-new Date(b.created_at);
  });

  // Reset to page 1
  page = 1;
  renderPage();
}

function renderPage(){
  const grid = $("#storyGrid");
  grid.innerHTML="";

  const start = (page-1)*PER_PAGE;
  const end = start + PER_PAGE;
  const slice = filtered.slice(start,end);

  if(slice.length===0){
    $("#empty").style.display="block";
    $("#pageInfo").textContent = "";
    return;
  }

  $("#empty").style.display="none";

  slice.forEach(it=>{
    const card = document.createElement("div");
    card.className="card";

    const labelsHTML = (it.labels||[])
      .map(l=>`<span class="label">${l.name}</span>`).join("");

    card.innerHTML=`
      <div class="card-title">${it.title}</div>
      <div class="meta">#${it.number} Â· ${it.state} Â· ${new Date(it.updated_at).toLocaleString()}</div>
      <div class="labels">${labelsHTML}</div>
    `;

    card.onclick = ()=>openSheet(it.number);
    grid.appendChild(card);
  });

  $("#pageInfo").textContent =
    `Page ${page} of ${Math.ceil(filtered.length/PER_PAGE)}`;

  $("#prevPage").disabled = (page===1);
  $("#nextPage").disabled = (page*PER_PAGE >= filtered.length);
}

/* ============================================================
   PAGINATION BUTTONS
============================================================ */
$("#prevPage").onclick = ()=>{
  if(page>1){ page--; renderPage(); }
};
$("#nextPage").onclick = ()=>{
  if(page*PER_PAGE < filtered.length){ page++; renderPage(); }
};

/* ============================================================
   BOTTOM SHEET PREVIEW
============================================================ */
async function openSheet(num){
  $("#sheet-backdrop").style.display="block";
  $("#sheet").classList.add("open");

  const res = await fetch(
    `https://api.github.com/repos/${OWNER}/${REPO}/issues/${num}`
  );
  const it = await res.json();

  $("#sheetTitle").textContent = it.title;

  const labelsHTML = (it.labels||[])
    .map(l=>`<span class="label">${l.name}</span>`).join("");

  $("#sheetContent").innerHTML = `
    <div><strong>ID:</strong> #${it.number}</div>
    <div><strong>Status:</strong> ${it.state}</div>
    <div><strong>Updated:</strong> ${new Date(it.updated_at).toLocaleString()}</div>

    <hr style="margin:1rem 0">

    <pre style="white-space:pre-wrap;background:#FAFAF7;padding:1rem;border-radius:var(--radius);border:1px solid var(--border);">
${it.body||""}
    </pre>

    <div style="margin-top:1.2rem">
      <strong>Labels:</strong><br>${labelsHTML}
    </div>

    <div style="margin-top:1.2rem">
      <a href="${it.html_url}" target="_blank">Open on GitHub â†—</a>
    </div>
  `;
}
function closeSheet(){
  $("#sheet-backdrop").style.display="none";
  $("#sheet").classList.remove("open");
}

$("#sheet-backdrop").onclick = closeSheet;
$("#sheetClose").onclick = closeSheet;

/* ============================================================
   CSV + PRINT
============================================================ */
$("#exportCsv").onclick = ()=>{
  let rows = [["number","title","state","updated","labels","body"]];
  issues.forEach(i=>{
    const labels = (i.labels||[]).map(l=>l.name).join("|");
    rows.push([
      i.number,
      i.title.replace(/"/g,'""'),
      i.state,
      i.updated_at,
      labels.replace(/"/g,'""'),
      (i.body||"").replace(/"/g,'""')
    ].map(v=>`"${v}"`).join(","));
  });

  const blob = new Blob([rows.join("\n")],{type:'text/csv'});
  const a = document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="stories.csv";
  a.click();
};

$("#printPdf").onclick = ()=>window.print();

/* ============================================================
   EVENTS
============================================================ */
$("#search").oninput = applyFilters;
$("#sort").onchange = applyFilters;
$("#refresh").onclick = ()=>loadIssues();

/* ============================================================
   INIT
============================================================ */
renderChips();
loadIssues();

</script>
</body>
</html>