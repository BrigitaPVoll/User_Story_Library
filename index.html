<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>User Story Library ¬∑ DeiC</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
/* ============================================================
   THEME ‚Äî DeiC Light + Dark
============================================================ */
:root{
  --deic-green:#BFD730;
  --deic-blue:#16385D;

  --bg:#F7F9F7;
  --card:#FFFFFF;
  --border:#DDE5D7;

  --text:#1B1F14;
  --muted:#667085;

  --chip-bg:#EFF6D9;
  --chip-selected:#BFD730;
  --chip-selected-text:#000;

  --radius:14px;
  --shadow:0 4px 15px rgba(0,0,0,.08);
  --shadow-hover:0 8px 24px rgba(0,0,0,.12);
}
.dark{
  --bg:#0E1523;
  --card:#151E2A;
  --border:#2C3A4D;
  --text:#E6EAF1;
  --muted:#99A3B3;
  --chip-bg:#273346;
  --chip-selected:#BFD730;
  --chip-selected-text:#000;
}

/* ============================================================
   BASE
============================================================ */
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,ui-sans-serif,system-ui;
  background:var(--bg); color:var(--text);
  transition:background .25s, color .25s;
}
.wrap{max-width:1100px; margin:0 auto; padding:0 1.25rem}
a{color:var(--deic-blue); text-decoration:none}
a:hover{text-decoration:underline}

/* ============================================================
   HEADER
============================================================ */
header{
  position:sticky; top:0; z-index:20;
  background:#fffffff0;
  backdrop-filter:blur(12px);
  border-bottom:3px solid var(--deic-green);
  box-shadow:var(--shadow);
}
.dark header{ background:#141a28d9; }
.header-row{
  display:flex; justify-content:space-between; align-items:center;
  padding:1rem 0; gap:1rem; flex-wrap:wrap;
}
.brand{ display:flex; align-items:center; gap:.75rem }
.logo{
  width:42px; height:42px; border-radius:12px;
  background:conic-gradient(from 180deg, var(--deic-green), var(--deic-blue), #000, var(--deic-green));
  border:1px solid var(--border); box-shadow:var(--shadow);
}
h1{margin:0; font-size:1.6rem; font-weight:800; color:var(--deic-blue)}
.dark h1{ color:var(--deic-green); }
.tagline{ margin:.2rem 0 0; color:var(--muted) }

.btn{
  padding:.65rem 1rem; border:none; border-radius:var(--radius);
  font-weight:600; cursor:pointer; transition:.15s;
}
.btn-primary{ background:var(--deic-green); color:#000 }
.btn-primary:hover{ filter:brightness(1.1) }
.btn-secondary{ background:var(--deic-blue); color:#fff }
.btn-secondary:hover{ filter:brightness(1.1) }

.switch{ display:flex; align-items:center; gap:.35rem; cursor:pointer }

/* ============================================================
   FILTERS
============================================================ */
.filters{
  margin-top:1rem; background:var(--card);
  border:1px solid var(--border); border-radius:var(--radius);
  padding:1rem; box-shadow:var(--shadow);
}
.filter-top{
  display:flex; gap:1rem; flex-wrap:wrap;
  align-items:center; justify-content:space-between;
}
input,select{
  padding:.65rem .75rem; border-radius:var(--radius);
  border:1px solid var(--border); background:var(--card); color:var(--text);
}

/* ============================================================
   FACETED FILTERS (expand/collapse)
============================================================ */
.facets{
  margin-top:1rem; display:flex; flex-direction:column; gap:1rem;
}
.facet{
  border:1px solid var(--border);
  border-radius:var(--radius);
  background:var(--card);
}
.facet-header{
  display:flex; justify-content:space-between; align-items:center;
  padding:.6rem .8rem; cursor:pointer;
}
.facet-title{
  margin:0; font-size:.95rem; font-weight:700; color:var(--muted);
}
.chevron{
  width:1rem; height:1rem; display:inline-block; transform:rotate(0deg); transition:transform .2s;
  border-right:2px solid var(--muted); border-bottom:2px solid var(--muted); transform-origin:center;
  rotate: -45deg; /* small caret look */
}
.facet.collapsed .chevron{ transform:rotate(135deg) } /* flip for collapsed */

.facet-body{
  overflow:hidden;
  transition:max-height .25s ease;
  max-height:500px;
  padding:0 .8rem .8rem;
}
.facet.collapsed .facet-body{
  max-height:0; padding-bottom:0;
}

.chip-row{ display:flex; flex-wrap:wrap; gap:.45rem; margin-top:.5rem }
.chip{
  padding:.35rem .7rem; border-radius:999px;
  background:var(--chip-bg); border:1px solid var(--border);
  cursor:pointer; font-size:.82rem; transition:.15s background;
}
.chip.selected{
  background:var(--chip-selected);
  border-color:var(--chip-selected);
  color:var(--chip-selected-text);
}

/* ============================================================
   GRID / CARDS
============================================================ */
.grid{
  margin-top:1.5rem;
  display:grid; gap:1.25rem;
  grid-template-columns:repeat(auto-fit, minmax(320px, 1fr));
}
.card{
  background:var(--card); border:1px solid var(--border);
  border-radius:var(--radius); padding:1.25rem;
  box-shadow:var(--shadow); cursor:pointer; transition:.2s ease;
}
.card:hover{ transform:translateY(-3px); box-shadow:var(--shadow-hover); border-color:var(--deic-green) }
.card-title{ font-size:1.1rem; font-weight:700; margin-bottom:.4rem }
.meta{ font-size:.85rem; color:var(--muted); margin-bottom:.6rem }
.labels{ display:flex; gap:.35rem; flex-wrap:wrap }
.label{
  padding:.2rem .55rem; border-radius:999px;
  background:#EFF6D9; border:1px solid var(--border);
  font-size:.75rem; color:#203018;
}
.dark .label{ background:#243044; color:#E6EAF1 }

/* ============================================================
   PAGINATION
============================================================ */
.pagination{
  margin:2rem 0; display:flex; gap:.5rem; justify-content:center; align-items:center;
}
.page-btn{
  padding:.5rem .9rem; border-radius:var(--radius);
  background:var(--card); border:1px solid var(--border); cursor:pointer;
}
.page-btn:hover{ background:var(--chip-bg) }
.page-info{ color:var(--muted); font-size:.9rem }

/* ============================================================
   BOTTOM-SHEET PREVIEW
============================================================ */
#sheet-backdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.3); display:none; z-index:90;
}
#sheet{
  position:fixed; left:0; right:0; bottom:-100%;
  background:var(--card); border-radius:24px 24px 0 0;
  box-shadow:0 -8px 25px rgba(0,0,0,.25);
  padding:1.5rem; max-height:85vh; overflow-y:auto; z-index:100;
  transition:bottom .35s cubic-bezier(.25,.8,.25,1);
}
#sheet.open{ bottom:0; }
.sheet-header{ display:flex; justify-content:space-between; align-items:center }
.sheet-title{ margin:0; font-size:1.25rem; font-weight:800 }
.sheet-close{
  background:var(--card); border:1px solid var(--border);
  padding:.45rem .8rem; border-radius:var(--radius); cursor:pointer;
}

/* ============================================================
   MODAL (Create Story; includes token field)
============================================================ */
#modal-backdrop{
  position:fixed; inset:0; background:rgba(0,0,0,.35);
  display:none; align-items:center; justify-content:center;
  z-index:200;
}
#modal{
  width:min(680px,92vw); background:var(--card);
  border:2px solid var(--deic-green); border-radius:var(--radius);
  padding:1.5rem; box-shadow:0 8px 40px rgba(0,0,0,.25);
}
.modal-title{ margin:0 0 .75rem; font-size:1.25rem; font-weight:800; color:var(--deic-blue) }
.dark .modal-title{ color:var(--deic-green) }
.modal-grid{ display:grid; gap:1rem; grid-template-columns:1fr 1fr }
.modal-grid .full{ grid-column:1 / -1 }
textarea{
  min-height:110px; resize:vertical; padding:.75rem;
  border:1px solid var(--border); border-radius:var(--radius);
}

</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="header-row">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>User Story Library</h1>
          <p class="tagline">FAIR use cases integrated with GitHub Issues</p>
        </div>
      </div>
      <div style="display:flex; gap:.5rem; flex-wrap:wrap">
        <button id="openModal" class="btn btn-primary">New Story</button>
        <button id="exportCsv" class="btn btn-secondary">CSV</button>
        <button id="printPdf" class="btn btn-secondary">Print / PDF</button>
        <label class="switch">
          <input id="darkToggle" type="checkbox"><span>üåô</span>
        </label>
      </div>
    </div>

    <!-- Top bar: search, sort, refresh -->
    <div class="filters">
      <div class="filter-top">
        <input id="search" placeholder="Search‚Ä¶"/>
        <select id="sort">
          <option value="newest">Newest first</option>
          <option value="oldest">Oldest first</option>
        </select>
        <button id="refresh" class="btn btn-primary">Refresh</button>
      </div>

      <!-- FACETED FILTERS with expand/collapse -->
      <div class="facets">

        <div class="facet" data-facet="consent">
          <div class="facet-header">
            <h3 class="facet-title">Contact Consent</h3>
            <span class="chevron"></span>
          </div>
          <div class="facet-body">
            <div id="facetConsent" class="chip-row"></div>
          </div>
        </div>

        <div class="facet" data-facet="domain">
          <div class="facet-header">
            <h3 class="facet-title">Domain</h3>
            <span class="chevron"></span>
          </div>
          <div class="facet-body">
            <div id="facetDomain" class="chip-row"></div>
          </div>
        </div>

        <div class="facet" data-facet="institution">
          <div class="facet-header">
            <h3 class="facet-title">Institution</h3>
            <span class="chevron"></span>
          </div>
          <div class="facet-body">
            <div id="facetInstitution" class="chip-row"></div>
          </div>
        </div>

      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <section id="storyGrid" class="grid"></section>
  <div id="empty" style="display:none; text-align:center; padding:2rem; color:var(--muted)">
    No user stories found.
  </div>

  <div class="pagination">
    <button id="prevPage" class="page-btn">Previous</button>
    <span id="pageInfo" class="page-info"></span>
    <button id="nextPage" class="page-btn">Next</button>
  </div>
</div>

<!-- Bottom-sheet preview -->
<div id="sheet-backdrop"></div>
<div id="sheet">
  <div class="sheet-header">
    <h3 id="sheetTitle" class="sheet-title">Loading‚Ä¶</h3>
    <button id="sheetClose" class="sheet-close">Close</button>
  </div>
  <div id="sheetContent"></div>
</div>

<!-- Modal: Create Story (uses your exact template in body) -->
<div id="modal-backdrop">
  <div id="modal">
    <h3 class="modal-title">Create New User Story</h3>

    <form id="storyForm">
      <div class="modal-grid">

        <div class="full">
          <label>Title</label>
          <input id="titleInput" placeholder='User Story: ' required />
        </div>

        <div>
          <label>As a‚Ä¶</label>
          <input id="roleInput" placeholder="e.g., researcher, data steward"/>
        </div>

        <div>
          <label>I want to‚Ä¶</label>
          <input id="goalInput" placeholder="the action you need to perform"/>
        </div>

        <div class="full">
          <label>‚Ä¶so that I can‚Ä¶</label>
          <input id="benefitInput" placeholder="the outcome/benefit"/>
        </div>

        <div class="full">
          <label>Additional context</label>
          <textarea id="contextInput" placeholder="data sources, workflows, constraints (legal/ethical/technical)‚Ä¶"></textarea>
        </div>

        <div class="full">
          <label>Contact consent</label>
          <select id="consentInput">
            <option value="Yes">Yes</option>
            <option value="No">No</option>
            <option value="N/A" selected>N/A</option>
          </select>
        </div>

        <div class="full">
          <label>Labels (comma, default keeps ‚Äúuser-story‚Äù)</label>
          <input id="labelsInput" value="user-story"/>
        </div>

        <div class="full">
          <label>Assignees (comma GitHub usernames)</label>
          <input id="assigneesInput" placeholder="e.g., BrigitaPVoll"/>
        </div>

        <div class="full">
          <label>GitHub Token (stored locally in your browser)</label>
          <input id="tokenInput" type="password" placeholder="ghp_‚Ä¶" />
          <small style="color:var(--muted)">
            Required for creating issues (fine‚Äëgrained: Issues Read & Write on this repository).
          </small>
        </div>

      </div>

      <div style="text-align:right; margin-top:1rem">
        <button type="button" id="cancelModal" class="btn btn-secondary">Cancel</button>
        <button type="submit" class="btn btn-primary">Create</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ============================================================
   CONFIG
============================================================ */
const OWNER = "BrigitaPVoll";
const REPO  = "User_Story_Library";
const PER_PAGE = 20;

/* Your faceted label groups (from your 17 labels) */
const LABELS = [
  "Contact consent>NO","Contact consent>YES",
  "Domain>Agricultural Sciences","Domain>Domain agnostic","Domain>Engineering and Technology",
  "Domain>Humanities","Domain>Medical and Health Sciences","Domain>Natural Sciences","Domain>Social Sciences",
  "Institution>Aalborg University","Institution>Aarhus University","Institution>Copenhagen Business School (CBS)",
  "Institution>IT University of Copenhagen","Institution>Roskilde University",
  "Institution>Technical University of Denmark (DTU)",
  "Institution>University of Copenhagen","Institution>University of Southern Denmark (SDU)"
];
const FACETS = {
  consent: ["Contact consent>YES","Contact consent>NO"],
  domain: LABELS.filter(x=>x.startsWith("Domain>")),
  inst: LABELS.filter(x=>x.startsWith("Institution>"))
};

/* DOM helpers */
const $ = s => document.querySelector(s);
function esc(s){ return String(s||"").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

/* State */
let issues = [];
let filtered = [];
let page = 1;
let activeChips = new Set();

/* ============================================================
   DARK MODE
============================================================ */
const darkToggle = $("#darkToggle");
if(localStorage.getItem("darkMode")==="true"){
  document.body.classList.add("dark");
  darkToggle.checked = true;
}
darkToggle.onchange = ()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("darkMode", document.body.classList.contains("dark"));
};

/* ============================================================
   FACETS (expand/collapse + chips)
============================================================ */
function buildFacet(container, labels){
  const box = $(container);
  box.innerHTML = "";
  labels.forEach(label=>{
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.textContent = label;
    chip.onclick = ()=>{
      if(activeChips.has(label)) activeChips.delete(label);
      else activeChips.add(label);
      chip.classList.toggle("selected");
      applyFilters();
    };
    box.appendChild(chip);
  });
}
function initFacets(){
  buildFacet("#facetConsent",     FACETS.consent);
  buildFacet("#facetDomain",      FACETS.domain);
  buildFacet("#facetInstitution", FACETS.inst);

  // Collapsible behavior
  document.querySelectorAll(".facet").forEach(f=>{
    const header = f.querySelector(".facet-header");
    header.addEventListener("click", ()=>{
      f.classList.toggle("collapsed");
    });
  });

  // Start with Domain and Institution collapsed to reduce visual noise
  document.querySelector('[data-facet="domain"]').classList.add("collapsed");
  document.querySelector('[data-facet="institution"]').classList.add("collapsed");
}

/* ============================================================
   LOAD ISSUES (state=all)
============================================================ */
async function loadIssues(){
  const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/issues?state=all&per_page=100`, {
    headers: { "Accept":"application/vnd.github+json" }
  });
  const data = await res.json();
  issues = (data||[]).filter(x=>!x.pull_request);
  applyFilters();
}

/* ============================================================
   FILTER + SORT + PAGINATE
============================================================ */
function applyFilters(){
  const q = ($("#search").value||"").toLowerCase();
  const sort = $("#sort").value;

  filtered = issues.filter(it=>{
    // text search
    const hay = `${it.title||""} ${it.body||""}`.toLowerCase();
    if(q && !hay.includes(q)) return false;

    // facets (AND across selected chips)
    if(activeChips.size>0){
      const names = (it.labels||[]).map(l=>l.name);
      for(const chip of activeChips){
        if(!names.includes(chip)) return false;
      }
    }
    return true;
  });

  // sort
  filtered.sort((a,b)=>{
    if(sort==="newest") return new Date(b.created_at) - new Date(a.created_at);
    return new Date(a.created_at) - new Date(b.created_at);
  });

  // reset pagination
  page = 1;
  renderPage();
}

function renderPage(){
  const grid = $("#storyGrid");
  grid.innerHTML = "";

  const start = (page-1)*PER_PAGE;
  const end   = start + PER_PAGE;
  const slice = filtered.slice(start, end);

  if(slice.length===0){
    $("#empty").style.display = "block";
    $("#pageInfo").textContent = "";
    $("#prevPage").disabled = true;
    $("#nextPage").disabled = true;
    return;
  }

  $("#empty").style.display = "none";

  slice.forEach(it=>{
    const labelsHTML = (it.labels||[]).map(l=>`<span class="label">${esc(l.name)}</span>`).join("");
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="card-title">${esc(it.title)}</div>
      <div class="meta">#${it.number} ¬∑ ${esc(it.state)} ¬∑ ${new Date(it.updated_at).toLocaleString()}</div>
      <div class="labels">${labelsHTML}</div>
    `;
    card.onclick = ()=> openSheet(it.number);
    grid.appendChild(card);
  });

  const pages = Math.max(1, Math.ceil(filtered.length / PER_PAGE));
  $("#pageInfo").textContent = `Page ${page} / ${pages}`;
  $("#prevPage").disabled = (page===1);
  $("#nextPage").disabled = (page>=pages);
}

$("#prevPage").onclick = ()=>{ if(page>1){ page--; renderPage(); } };
$("#nextPage").onclick = ()=>{
  const pages = Math.ceil(filtered.length / PER_PAGE);
  if(page<pages){ page++; renderPage(); }
};

/* ============================================================
   BOTTOM-SHEET PREVIEW
============================================================ */
async function openSheet(number){
  $("#sheet-backdrop").style.display = "block";
  $("#sheet").classList.add("open");
  $("#sheetTitle").textContent = `#${number} ‚Äî Loading‚Ä¶`;
  $("#sheetContent").innerHTML = "";

  const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/issues/${number}`, {
    headers: { "Accept":"application/vnd.github+json" }
  });
  const it = await res.json();

  const labelsHTML = (it.labels||[]).map(l=>`<span class="label">${esc(l.name)}</span>`).join("");

  $("#sheetTitle").textContent = it.title || `Issue #${it.number}`;
  $("#sheetContent").innerHTML = `
    <div><strong>ID:</strong> #${it.number}</div>
    <div><strong>Status:</strong> ${esc(it.state||"")}</div>
    <div><strong>Updated:</strong> ${new Date(it.updated_at).toLocaleString()}</div>

    <hr style="margin:1rem 0">

    <pre style="white-space:pre-wrap;background:#F2F3F6;padding:1rem;border-radius:var(--radius);border:1px solid var(--border);">
${esc(it.body||"")}
    </pre>

    <div style="margin-top:1rem">
      <strong>Labels:</strong><br>${labelsHTML||"<span class='meta'>No labels</span>"}
    </div>

    <div style="margin-top:1rem">
      ${esc(it.html_url||"")}Open on GitHub ‚Üó</a>
    </div>
  `;
}
function closeSheet(){
  $("#sheet-backdrop").style.display = "none";
  $("#sheet").classList.remove("open");
}
$("#sheet-backdrop").onclick = closeSheet;
$("#sheetClose").onclick = closeSheet;

/* ============================================================
   CREATE STORY ‚Äî Uses YOUR EXACT TEMPLATE in body
============================================================ */
$("#openModal").onclick = ()=> $("#modal-backdrop").style.display="flex";
$("#cancelModal").onclick = ()=> $("#modal-backdrop").style.display="none";

$("#storyForm").onsubmit = async (e)=>{
  e.preventDefault();

  const token = $("#tokenInput").value.trim();
  if(!token){ alert("A GitHub token is required to create issues."); return; }

  const title    = ($("#titleInput").value || "User Story: ").trim();
  const role     = $("#roleInput").value.trim();
  const goal     = $("#goalInput").value.trim();
  const benefit  = $("#benefitInput").value.trim();
  const context  = $("#contextInput").value.trim();
  const consent  = $("#consentInput").value;
  const labels   = ($("#labelsInput").value || "user-story").split(",").map(x=>x.trim()).filter(Boolean);
  if(!labels.includes("user-story")) labels.unshift("user-story");
  const assignees= $("#assigneesInput").value.split(",").map(x=>x.trim()).filter(Boolean);

  // Build issue body using your EXACT template block
  const body = [
    '---',
    'name: User Story',
    'about: A FAIR use case describing who needs what data, for what purpose, and under what conditions.',
    'title: "User Story: "',
    'labels: ["user-story"]',
    'assignees: ""',
    '---',
    '',
    '## üß© User story',
    '',
    'Please follow the standard user‚Äëstory syntax.',
    '',
    '**As a**',
    (role ? role : '‚Ä¶'),
    '',
    '**I want to**',
    (goal ? goal : '‚Ä¶'),
    '',
    '**So that I can**',
    (benefit ? benefit : '‚Ä¶'),
    '',
    '---',
    '',
    '## üìå Additional context',
    '',
    (context ? context : '‚Ä¶'),
    '',
    '---',
    '',
    '## üì¨ Contact for future EOSC‚Äëfunded FAIR projects',
    '',
    'Can we contact you to participate in a future EOSC‚Äëfunded project on FAIR data management?',
    '',
    (consent==="Yes" ? '- [x] **Yes**\n- [ ] **No**' :
     consent==="No"  ? '- [ ] **Yes**\n- [x] **No**' :
                        '- [ ] **Yes**\n- [ ] **No**'),
    '',
    '<!--',
    'If yes, please leave your preferred contact details in a comment',
    '(e.g. email or GitHub username).',
    '-->'
  ].join('\n');

  const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/issues`,{
    method:"POST",
    headers:{
      "Accept":"application/vnd.github+json",
      "Authorization":"Bearer " + token,
      "Content-Type":"application/json"
    },
    body: JSON.stringify({
      title,        // uses the Title field directly
      body,         // your full structured template body
      labels,       // ensure "user-story" is present
      assignees
    })
  });

  if(!res.ok){
    alert("Failed to create issue: " + (await res.text()));
    return;
  }

  alert("Story created!");
  $("#modal-backdrop").style.display="none";
  // reload from GitHub to include the new one
  loadIssues();
};

/* ============================================================
   CSV + PRINT
============================================================ */
$("#exportCsv").onclick = ()=>{
  const rows = [["number","title","state","updated","labels","body"]];
  issues.forEach(i=>{
    const labels = (i.labels||[]).map(l=>l.name).join("|").replace(/"/g,'""');
    const body = (i.body||"").replace(/"/g,'""');
    rows.push([
      i.number,
      (i.title||"").replace(/"/g,'""'),
      i.state||"",
      i.updated_at||"",
      labels,
      body
    ].map(v=>/[,\"\n]/.test(v)?`"${v}"`:v).join(","));
  });
  const blob = new Blob([rows.join("\n")],{type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "user_stories.csv";
  a.click();
};
$("#printPdf").onclick = ()=> window.print();

/* ============================================================
   EVENTS
============================================================ */
$("#search").oninput = applyFilters;
$("#sort").onchange = applyFilters;
$("#refresh").onclick = loadIssues;

/* ============================================================
   INIT
============================================================ */
initFacets();
loadIssues();

</script>
</body>
</html>