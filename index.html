<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>User Story Library · DeiC Light Hybrid</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
:root {
  --bg: #F7F9F7;
  --card-bg: #FFFFFF;
  --border: #E2E8E4;
  --text: #1A1F17;
  --muted: #667075;
  --lime: #BFD730;
  --lime-dark: #A0B120;
  --teal: #16385D;
  --teal-light: #1E4A7A;
  --radius: 14px;
  --shadow: 0 4px 15px rgba(0,0,0,.08);
  --shadow-hover: 0 8px 22px rgba(0,0,0,.12);
}
body {
  margin:0; font-family:Inter,sans-serif;
  background:var(--bg); color:var(--text); line-height:1.55;
}
*{box-sizing:border-box}
a{color:var(--lime)}
header {
  position:sticky; top:0; z-index:20;
  background:rgba(255,255,255,0.85);
  backdrop-filter:blur(12px);
  border-bottom:3px solid var(--lime);
  box-shadow:0 4px 16px rgba(0,0,0,.1);
}
.wrap{max-width:1100px;margin:0 auto;padding:0 1.25rem}
.header-row{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
.brand{display:flex;align-items:center;gap:.75rem}
.logo{width:42px;height:42px;border-radius:12px;
  background:conic-gradient(from180deg,var(--lime),var(--teal),#000,var(--lime));
  border:1px solid var(--border);box-shadow:var(--shadow)}
h1{margin:0;font-size:1.6rem;font-weight:800}
.tagline{margin:.3rem 0 0;color:var(--muted)}
.btn{padding:.65rem 1rem;border-radius:var(--radius);border:none;font-weight:600;cursor:pointer;transition:.15s}
.btn-primary{background:var(--lime);color:#000;box-shadow:var(--shadow)}
.btn-secondary{background:var(--teal);color:#fff;box-shadow:var(--shadow)}
.btn:hover{filter:brightness(1.1);transform:translateY(-1px)}
.filters{margin-top:1rem;background:#fff;border:1px solid var(--border);padding:1rem;border-radius:var(--radius);box-shadow:var(--shadow)}
.controls-row{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr;gap:.75rem}
@media(max-width:900px){.controls-row{grid-template-columns:1fr 1fr 1fr 1fr 1fr}}
@media(max-width:600px){.controls-row{grid-template-columns:1fr 1fr 1fr}}
label{font-size:.85rem;color:var(--muted)}
input,select{width:100%;padding:.65rem .75rem;border-radius:var(--radius);border:1px solid var(--border);background:#fff;color:var(--text)}
main{padding:2rem 1.25rem 5rem}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1.25rem;margin-top:1.25rem}
.card{background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;box-shadow:var(--shadow);transition:.2s;cursor:pointer}
.card:hover{transform:translateY(-3px);box-shadow:var(--shadow-hover);border-color:var(--lime)}
.card-title{font-size:1.05rem;font-weight:600;margin-bottom:.5rem}
.meta{color:var(--muted);font-size:.82rem;margin-bottom:.5rem}
.labels-row{display:flex;flex-wrap:wrap;gap:.35rem}
.label{padding:.2rem .55rem;background:#E8F3E0;border-radius:999px;border:1px solid var(--border);font-size:.75rem;color:var(--text)}
#drawer-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.3);display:none;z-index:90}
#drawer{position:fixed;left:50%;bottom:-90%;transform:translateX(-50%);width:min(720px,94vw);background:#fff;border-top:3px solid var(--lime);border-radius:24px 24px 0 0;padding:1.5rem;box-shadow:var(--shadow-deep);transition:bottom .35s cubic-bezier(.25,.8,.25,1);max-height:88vh;overflow-y:auto;z-index:100}
#drawer.open{bottom:0}
.drawer-header{display:flex;justify-content:space-between;align-items:center}
.drawer-title{font-size:1.3rem;font-weight:800;color:var(--lime)}
.drawer-close{padding:.45rem .8rem;border-radius:var(--radius);background:#fff;border:1px solid var(--border);cursor:pointer}
.drawer-close:hover{background:#f0f5e0}
.drawer-section{margin-bottom:1.5rem}
#modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;place-items:center;z-index:120}
#modal{width:min(680px,92vw);background:#fff;border:1px solid var(--lime);border-radius:var(--radius);padding:1.5rem;color:var(--text);box-shadow:var(--shadow-deep);max-height:90vh;overflow-y:auto}
#modal h2{margin:0 0 1rem;color:var(--lime)}
.modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.modal-grid .full{grid-column:1/-1}
textarea{width:100%;background:#fff;border-radius:var(--radius);border:1px solid var(--border);color:var(--text);padding:.75rem}
.chips{display:flex;flex-wrap:wrap;gap:.45rem;margin-bottom:.75rem}
.chip{padding:.35rem .7rem;border-radius:999px;background:#E8F3E0;border:1px solid var(--border);cursor:pointer;font-size:.78rem}
.chip.selected{background:var(--lime);color:#000;border-color:var(--lime-dark)}
footer{text-align:center;color:var(--muted);padding:2rem 0;font-size:.85rem}
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="header-row">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>User Story Library</h1>
          <p class="tagline">FAIR use cases across domains and institutions.</p>
        </div>
      </div>
      <div class="header-actions">
        <button id="openNew" class="btn btn-primary">New Story</button>
        <button id="exportCsv" class="btn btn-secondary">Export CSV</button>
        <button id="printPdf" class="btn btn-secondary">Print / Save PDF</button>
      </div>
    </div>
    <div class="filters">
      <div class="controls-row">
        <div><label>Search</label><input id="search" placeholder="Search…"/></div>
        <div><label>State</label><select id="state"><option value="open">Open</option><option value="closed">Closed</option><option value="all">All</option></select></div>
        <div><label>Domain</label><select id="filterDomain"><option value="">All domains</option></select></div>
        <div><label>Institution</label><select id="filterInstitution"><option value="">All institutions</option></select></div>
        <div><label>&nbsp;</label><button id="refresh" class="btn btn-primary" style="width:100%;">Refresh</button></div>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div id="statusArea" style="margin:.75rem 0;color:var(--muted);font-size:.9rem;"><span id="rateInfo"></span></div>
    <div id="storyGrid" class="grid"></div>
    <div id="emptyMsg" style="display:none;color:var(--muted);text-align:center;padding:2rem 0;">No stories found.</div>
    <div style="display:flex;justify-content:center;margin-top:1rem;"><button id="loadMore" class="btn btn-secondary" style="display:none;">Load more</button></div>
  </div>
</main>

<footer><div class="wrap"><small>Powered by GitHub Issues · DeiC Hybrid Light</small></div></footer>

<div id="drawer-backdrop"></div>
<div id="drawer">
  <div class="drawer-header">
    <h3 id="drawerTitle" class="drawer-title">Loading…</h3>
    <button id="drawerClose" class="drawer-close">Close</button>
  </div>
  <div id="drawerContent"></div>
</div>

<div id="modal-backdrop">
  <div id="modal">
    <h2>New User Story</h2>
    <form id="newStoryForm">
      <div class="modal-grid">
        <div class="full"><label>Title</label><input id="titleInput" required placeholder="Short title"/></div>
        <div><label>As a…</label><input id="roleInput" placeholder="Role"/></div>
        <div><label>I want to…</label><input id="goalInput" placeholder="Goal"/></div>
        <div class="full"><label>…so that I can…</label><input id="benefitInput" placeholder="Benefit"/></div>
        <div class="full"><label>Additional context</label><textarea id="contextInput"></textarea></div>
        <div class="full"><label>Contact consent</label><select id="consentInput"><option value="N/A">N/A</option><option value="Yes">YES</option><option value="No">NO</option></select></div>
        <div class="full"><label>Labels</label><div id="chips" class="chips"></div></div>
        <div class="full"><label>Assignees (optional)</label><input id="assigneesInput" placeholder="comma-separated GitHub usernames"/></div>
      </div>
      <div style="margin-top:1.25rem;display:flex;justify-content:flex-end;gap:.5rem;">
        <button type="button" id="cancelModal" class="btn btn-secondary">Cancel</button>
        <button type="submit" class="btn btn-primary">Create Story</button>
      </div>
    </form>
  </div>
</div>

<script>
const OWNER="BrigitaPVoll",REPO="User_Story_Library",PER_PAGE=20;
const LABELS=[
  "Contact consent>NO","Contact consent>YES",
  "Domain>Agricultural Sciences","Domain>Domain agnostic","Domain>Engineering and Technology",
  "Domain>Humanities","Domain>Medical and Health Sciences","Domain>Natural Sciences","Domain>Social Sciences",
  "Institution>Aalborg University","Institution>Aarhus University","Institution>Copenhagen Business School (CBS)",
  "Institution>IT University of Copenhagen","Institution>Roskilde University",
  "Institution>Technical University of Denmark (DTU)",
  "Institution>University of Copenhagen","Institution>University of Southern Denmark (SDU)"
];
const DOMAINS=LABELS.filter(l=>l.startsWith("Domain>")).map(l=>l.replace("Domain>",""));
const INSTITUTIONS=LABELS.filter(l=>l.startsWith("Institution>")).map(l=>l.replace("Institution>",""));
let page=1,issues=[],selected=new Set();
const $=s=>document.querySelector(s);

function headers(){return{"Accept":"application/vnd.github+json"}}
async function api(u){const r=await fetch(u,{headers:headers()});if(!r.ok)throw new Error(await r.text());return r.json()}

async function loadIssues(reset=false){
  if(reset){page=1;issues=[]}
  const state=$("#state").value;
  const url=`https://api.github.com/repos/${OWNER}/${REPO}/issues?state=${state}&per_page=${PER_PAGE}&page=${page}`;
  const batch=await api(url);
  issues=issues.concat(batch.filter(i=>!i.pull_request));
  renderIssues();
  $("#loadMore").style.display=batch.length===PER_PAGE?"":"none";
}

function renderIssues(){
  const q=$("#search").value.toLowerCase().trim();
  const d=$("#filterDomain").value;
  const inst=$("#filterInstitution").value;
  const filtered=issues.filter(i=>{
    const hay=(i.title+i.body+i.number).toLowerCase();
    if(q&&!hay.includes(q))return false;
    const names=(i.labels||[]).map(l=>l.name);
    if(d&&!names.includes(`Domain>${d}`))return false;
    if(inst&&!names.includes(`Institution>${inst}`))return false;
    return true;
  });
  $("#storyGrid").innerHTML="";
  $("#emptyMsg").style.display=filtered.length?"none":"block";
  filtered.forEach(issue=>{
    const card=document.createElement("div");card.className="card";
    const labelsHTML=(issue.labels||[]).map(l=>`<span class="label">${l.name}</span>`).join("");
    card.innerHTML=`
      <div class="card-title">${issue.title}</div>
      <div class="meta">#${issue.number} • ${issue.state}</div>
      <div class="labels-row">${labelsHTML}</div>`;
    card.onclick=()=>openDrawer(issue.number);
    $("#storyGrid").appendChild(card);
  });
}

async function openDrawer(num){
  $("#drawer-backdrop").style.display="block";
  $("#drawer").classList.add("open");
  $("#drawerTitle").textContent="Loading…";
  $("#drawerContent").innerHTML="";
  const issue=await api(`https://api.github.com/repos/${OWNER}/${REPO}/issues/${num}`);
  $("#drawerTitle").textContent=issue.title;
  const labelsHTML=(issue.labels||[]).map(l=>`<span class="label">${l.name}</span>`).join("");
  $("#drawerContent").innerHTML=`
    <div class="drawer-section"><h3>Description</h3><pre style="white-space:pre-wrap;">${issue.body}</pre></div>
    <div class="drawer-section"><h3>Labels</h3>${labelsHTML}</div>
    <div class="drawer-section">${issue.html_url}Open on GitHub</a></div>`;
}

function closeDrawer(){
  $("#drawer-backdrop").style.display="none";
  $("#drawer").classList.remove("open");
}

function initChips(){
  selected.clear();
  const box=$("#chips");box.innerHTML="";
  LABELS.forEach(l=>{
    const el=document.createElement("span");
    el.className="chip";el.textContent=l;
    el.onclick=()=>{
      if(selected.has(l)){selected.delete(l);el.classList.remove("selected")}
      else{selected.add(l);el.classList.add("selected")}
    };
    box.appendChild(el);
  });
}

async function createStory(){
  const title=$("#titleInput").value.trim();
  if(!title)return alert("Title required");
  const body=[
    "User Story","",
    `As a ${$("#roleInput").value}, I want to ${$("#goalInput").value}, so that I can ${$("#benefitInput").value}.`,
    "","Additional context:",$("#contextInput").value.trim(),
    "","Contact consent:",$("#consentInput").value
  ].join("\n");
  const labels=[...selected,"user-story"];
  const assignees=$("#assigneesInput").value.split(",").map(x=>x.trim()).filter(Boolean);
  const res=await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/issues`,{
    method:"POST",
    headers:{"Accept":"application/vnd.github+json","Content-Type":"application/json"},
    body:JSON.stringify({title,body,labels,assignees})
  });
  if(!res.ok)return alert("Error: "+(await res.text()));
  alert("Story created!");closeModal();loadIssues(true);
}

function openModal(){ $("#modal-backdrop").style.display="grid"; }
function closeModal(){ $("#modal-backdrop").style.display="none"; }

function exportCSV(){
  const rows=[["number","title","state","updated_at","labels","body"].join(",")];
  issues.forEach(i=>{
    const labels=(i.labels||[]).map(l=>l.name).join("|").replace(/"/g,'""');
    const body=(i.body||"").replace(/"/g,'""');
    rows.push([i.number,`"${i.title.replace(/"/g,'""')}"`,i.state,i.updated_at,`"${labels}"`,`"${body}"`].join(","));
  });
  const blob=new Blob([rows.join("\n")],{type:"text/csv"});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);
  a.download="user_stories.csv";a.click();
}

$("#openNew").onclick=()=>{initChips();openModal()};
$("#cancelModal").onclick=closeModal;
$("#drawerClose").onclick=closeDrawer;
$("#drawer-backdrop").onclick=closeDrawer;
$("#refresh").onclick=()=>loadIssues(true);
$("#state").onchange=()=>loadIssues(true);
$("#filterDomain").onchange=renderIssues;
$("#filterInstitution").onchange=renderIssues;
