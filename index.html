<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>User Story Library ¬∑ DeiC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Add your CSS styles here */
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="header-row">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>User Story Library</h1>
          <p class="tagline">FAIR use cases integrated with GitHub Issues</p>
        </div>
      </div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button id="openModal" class="btn btn-primary">New Story</button>
        <button id="exportCsv" class="btn btn-secondary">CSV</button>
        <button id="printPdf" class="btn btn-secondary">Print/PDF</button>
        <label class="switch"><input id="darkToggle" type="checkbox"><span>üåô</span></label>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <section id="storyGrid" class="grid"></section>
  <div id="empty" style="display:none;text-align:center;padding:2rem;color:var(--muted)">No user stories found.</div>
  <div class="pagination">
    <button id="prevPage" class="page-btn">Previous</button>
    <span id="pageInfo" class="page-info"></span>
    <button id="nextPage" class="page-btn">Next</button>
  </div>
</div>

<!-- Create Story Modal -->
<div id="modal-backdrop">
  <div id="modal">
    <h3 class="modal-title">Create New User Story</h3>
    <form id="storyForm">
      <div class="modal-grid">
        <div class="full">
          <label>Title</label>
          <input id="titleInput" placeholder='User Story: ' required />
        </div>
        <div>
          <label>As a‚Ä¶</label>
          <input id="roleInput" placeholder="e.g., researcher, data steward" required />
        </div>
        <div>
          <label>I want to‚Ä¶</label>
          <input id="goalInput" placeholder="action you want to perform" required />
        </div>
        <div class="full">
          <label>‚Ä¶so that I can‚Ä¶</label>
          <input id="benefitInput" placeholder="the outcome/benefit" required />
        </div>
        <div class="full">
          <label>Additional context</label>
          <textarea id="contextInput" placeholder="data sources, domain, workflows, constraints‚Ä¶" required></textarea>
        </div>
        <div class="full">
          <label>Contact consent</label>
          <select id="consentInput" required>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
            <option value="N/A" selected>N/A</option>
          </select>
        </div>
        <div class="full">
          <label>Labels (comma; default keeps ‚Äúuser-story‚Äù)</label>
          <input id="labelsInput" value="user-story" />
        </div>
      </div>
      <div class="hint">
        To create issues, ensure a token exists in <code>localStorage</code>:<br />
        <code>localStorage.setItem('GITHUB_TOKEN','ghp_‚Ä¶')</code>
      </div>
      <div style="text-align:right;margin-top:1rem">
        <button type="button" id="cancelModal" class="btn btn-secondary">Cancel</button>
        <button type="submit" class="btn btn-primary">Create</button>
      </div>
    </form>
  </div>
</div>

<script>
  const OWNER = "BrigitaPVoll";
  const REPO = "User_Story_Library";

  document.getElementById("openModal").onclick = () => {
    document.getElementById("modal-backdrop").style.display = "flex";
  };

  document.getElementById("cancelModal").onclick = () => {
    document.getElementById("modal-backdrop").style.display = "none";
  };

  document.getElementById("storyForm").onsubmit = async (e) => {
    e.preventDefault();

    const token = localStorage.getItem("GITHUB_TOKEN");
    if (!token) {
      alert("To create issues, set a token in localStorage:\nlocalStorage.setItem('GITHUB_TOKEN','ghp_‚Ä¶')");
      return;
    }

    const title = document.getElementById("titleInput").value.trim();
    const role = document.getElementById("roleInput").value.trim();
    const goal = document.getElementById("goalInput").value.trim();
    const benefit = document.getElementById("benefitInput").value.trim();
    const context = document.getElementById("contextInput").value.trim();
    const consent = document.getElementById("consentInput").value;
    const labels = (document.getElementById("labelsInput").value || "user-story").split(",").map(x => x.trim()).filter(Boolean);
    if (!labels.includes("user-story")) labels.unshift("user-story");

    const body = [
      '---',
      'name: User Story',
      'about: A FAIR use case describing who needs what data, for what purpose, and under what conditions.',
      'title: "User Story: "',
      'labels: ["user-story"]',
      'assignees: ""',
      '---',
      '',
      '## üß© User story',
      '**As a**',
      role || '‚Ä¶',
      '**I want to**',
      goal || '‚Ä¶',
      '**So that I can**',
      benefit || '‚Ä¶',
      '---',
      '## üìå Additional context',
      context || '‚Ä¶',
      '---',
      '## üì¨ Contact for future EOSC-funded FAIR projects',
      consent === "Yes" ? '- [x] **Yes**\n- [ ] **No**' :
      consent === "No" ? '- [ ] **Yes**\n- [x] **No**' : '- [ ] **Yes**\n- [ ] **No**',
      '<!-- If yes, please leave your preferred contact details in a comment (e.g. email or GitHub username). -->'
    ].join('\n');

    try {
      const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/issues`, {
        method: "POST",
        headers: {
          "Accept": "application/vnd.github+json",
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ title, body, labels })
      });

      if (!res.ok) {
        const errorData = await res.json();
        alert("Failed to create issue: " + (errorData.message || "Unknown error"));
        return;
      }

      alert("Story created successfully!");
      document.getElementById("modal-backdrop").style.display = "none";
      // Optionally reload or update the story list here
    } catch (error) {
      alert("An error occurred: " + error.message);
    }
  };
</script>
</body>
</html>
