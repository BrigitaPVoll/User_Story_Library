<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>User Story Library | DeiC style</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <style>
    /* ==== DeiC palette & layout variables ==== */
    :root{
      --deic-yellow: #D4EF37;  /* Primary: vibrant yellow-green */
      --deic-dark: #1A1A1A;    /* Secondary: near-black */
      --deic-blue:  #16385D;   /* Supporting */

      /* Page background */
      --bg: #f8f8f6;           /* Off-white */
      --fg: #1A1A1A;           /* Near-black text */
      --muted: #666666;        /* Medium grey */

      --card: #ffffff;         /* Clean white */
      --border: #e0e0dc;       /* Light grey border */

      --accent: #D4EF37;       /* Primary yellow-green */
      --accent-dark: #B8C82E;  /* Darker yellow-green for hover */
      --accent-contrast: #1A1A1A;  /* Dark text on accent */

      /* Header & controls */
      --header-bg: #ffffff;
      --header-border: #D4EF37;
      --accent-soft: rgba(212, 239, 55, 0.12);

      --control-bg: #ffffff;
      --control-border: #e0e0dc;
      --control-shadow: 0 2px 8px rgba(0,0,0,.06);

      --link: #D4EF37;
      --shadow: 0 4px 12px rgba(0,0,0,.08);
    }

    /* Dark mode */
    html.dark-mode{
      --bg: #121212;
      --fg: #f5f5f5;
      --muted: #999999;
      --card: #1e1e1e;
      --border: #333333;
      --accent-contrast: #1A1A1A;
      --header-bg: #1e1e1e;
      --header-border: #D4EF37;
      --control-bg: #1e1e1e;
      --control-border: #333333;
      --control-shadow: 0 4px 12px rgba(0,0,0,.3);
      --accent-soft: rgba(212, 239, 55, 0.15);
      --link: #D4EF37;
    }

    @media (prefers-color-scheme: dark){
      html:not(.light-mode){
        --bg: #121212;
        --fg: #f5f5f5;
        --muted: #999999;
        --card: #1e1e1e;
        --border: #333333;
        --accent-contrast: #1A1A1A;
        --header-bg: #1e1e1e;
        --header-border: #D4EF37;
        --control-bg: #1e1e1e;
        --control-border: #333333;
        --control-shadow: 0 4px 12px rgba(0,0,0,.3);
        --accent-soft: rgba(212, 239, 55, 0.15);
        --link: #D4EF37;
      }
    }


    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 600px at 10% -10%, color-mix(in oklab, var(--deic-green) 8%, transparent), transparent 45%),
        radial-gradient(900px 450px at 85% 0%, color-mix(in oklab, var(--deic-sprout) 8%, transparent), transparent 45%),
        var(--bg);
      color:var(--fg);
      line-height:1.55;
    }

    /* ==== Header (opaque & elevated for contrast) ==== */
    header{
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--header-bg);
      border-bottom: 4px solid var(--header-border);
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:1rem 1.25rem}
    .bar{display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:.75rem}
    .logo{
      width:40px; height:40px; border-radius:10px;
      background: conic-gradient(from 180deg, var(--deic-green), var(--deic-sprout), var(--deic-blue), var(--deic-green));
      box-shadow:var(--shadow); border:1px solid var(--border);
    }
    h1{font-size: clamp(1.1rem, 2vw, 1.6rem); margin:0; letter-spacing:.2px; color: var(--deic-blue); font-weight:700}
    .tagline{color: color-mix(in oklab, var(--muted) 85%, #000); font-size:.95rem; margin:.3rem 0 0 0; max-width:900px}

    .cta-row{display:flex; align-items:center; gap:.5rem; flex-wrap:wrap}
    .button-link{
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.6rem .8rem; border-radius:.6rem; border:1px solid var(--control-border);
      background: var(--accent); color: var(--accent-contrast); font-weight:600; text-decoration:none;
      box-shadow: var(--control-shadow);
    }
    .button-link:hover{filter:brightness(1.05)}
    .secondary{ background: var(--control-bg); color: var(--fg); border-color: var(--control-border) }

    /* ==== Dark mode toggle ==== */
    .theme-toggle{
      background: var(--control-bg); color: var(--fg); border:1px solid var(--control-border);
      padding:.5rem .7rem; border-radius:.6rem; cursor:pointer; font-size:1rem;
      display:inline-flex; align-items:center; gap:.4rem; transition:all 0.2s ease;
      box-shadow: var(--control-shadow);
    }
    .theme-toggle:hover{background:var(--accent-soft); border-color:var(--accent);}
    
    /* ==== Dark mode toggle ==== */
    .theme-toggle{
      background: var(--control-bg); color: var(--fg); border:1px solid var(--control-border);
      padding:.5rem .7rem; border-radius:.6rem; cursor:pointer; font-size:1rem;
      display:inline-flex; align-items:center; gap:.4rem; transition:all 0.2s ease;
    }
    .theme-toggle:hover{background:var(--accent-soft); border-color:var(--accent);}

    /* ==== Controls: crisp white surface ==== */
    .controls{display:grid; grid-template-columns:1fr; gap:.75rem; margin-top:.75rem; background: color-mix(in oklab, var(--control-bg) 94%, transparent); border: 1px solid var(--control-border); border-radius: 12px; padding: .8rem; box-shadow: var(--control-shadow);}
    .controls-row{display:grid; grid-template-columns:2fr 1fr 1fr auto auto; gap:.5rem}
    @media (max-width:1000px){ .controls-row{grid-template-columns:1fr 1fr 1fr 1fr} }
    @media (max-width:700px){ .controls-row{grid-template-columns:1fr 1fr} }
    @media (max-width:520px){ .controls-row{grid-template-columns:1fr} }

    label{font-size:.85rem; color:var(--muted)}
    input, select, button{
      padding:.6rem .7rem; border-radius:.6rem; border:1px solid var(--control-border);
      background:var(--control-bg); color:var(--fg); outline:none;
    }
    input, select{width:100%}
    button.primary{background:var(--accent); color:var(--accent-contrast); border:none; font-weight:600; box-shadow:var(--control-shadow); cursor:pointer}
    button.primary:hover{filter:brightness(1.06)}
    .token-box{display:none}
    .inline{display:flex; align-items:center; gap:.5rem}
    small{color:var(--muted)}

    /* ==== Main content ==== */
    main{max-width:1100px; margin:0 auto; padding:1rem 1.25rem 3rem}
    .status{margin:1rem 0; font-size:.95rem; color:var(--muted); display:flex; align-items:center; gap:.75rem; flex-wrap:wrap}
    .rate{font-size:.85rem; color:var(--muted); padding:.1rem .4rem; border:1px solid var(--control-border); border-radius:999px; background:var(--control-bg)}
    .grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); gap:1rem}
    .card{
      background: var(--card);
      border:1px solid var(--border); border-radius:14px; padding:1rem; box-shadow:var(--shadow);
      display:flex; flex-direction:column; gap:.6rem; transition:transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover{transform:translateY(-4px); box-shadow:0 12px 24px rgba(0,0,0,.15);}
    .card h3{margin:.1rem 0 .25rem; font-size:1.05rem; line-height:1.35}
    .meta{display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; color:var(--muted); font-size:.85rem}
    .labels{display:flex; gap:.35rem; flex-wrap:wrap}
    .label{background: color-mix(in oklab, var(--deic-green) 15%, white); color:var(--fg); border:1px solid var(--border); border-radius:999px; padding:.15rem .55rem; font-size:.78rem}
    .assignees{display:flex; align-items:center; gap:.35rem}
    .assignees img{width:20px; height:20px; border-radius:50%; border:1px solid var(--border)}
    .pill{border-radius:999px; padding:.12rem .5rem; font-size:.78rem; border:1px solid var(--border)}
    .pill.ok{background: color-mix(in oklab, #22c55e 18%, white); color:var(--fg)}
    .pill.no{background: color-mix(in oklab, #ef4444 18%, white); color:var(--fg)}
    .pill.na{background: color-mix(in oklab, #f59e0b 18%, white); color:var(--fg)}
    .desc{font-size:.95rem}
    .story-parts{display:flex; flex-wrap:wrap; gap:.35rem}
    .story-part{border:1px dashed var(--border); border-radius:8px; padding:.25rem .5rem; font-size:.82rem; color:var(--muted)}
    .empty,.error{text-align:center; color:var(--muted); padding:2rem 0}
    a { color: var(--link); text-decoration: none }
    a:hover { text-decoration: underline }
    .notice { font-size: .82rem; color: var(--muted) }

    /* ==== Modal (New User Story) ==== */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:50}
    .modal{width:min(720px, 92vw); background:var(--control-bg); color:var(--fg); border:1px solid var(--control-border); border-radius:14px; box-shadow:0 16px 40px rgba(0,0,0,.18)}
    .modal header{position:static; background:var(--control-bg); border-bottom:1px solid var(--control-border); box-shadow:none}
    .modal .wrap{padding:1rem 1.25rem}
    .modal h2{margin:.2rem 0 0; font-size:1.2rem; color:var(--deic-blue)}
    .modal .grid-form{display:grid; grid-template-columns:1fr 1fr; gap:.8rem}
    .modal .grid-form .full{grid-column:1/-1}
    .modal .actions{display:flex; justify-content:flex-end; gap:.5rem; margin-top:.5rem}

    textarea{min-height:100px; resize:vertical}

    /* ==== Assignee selector ==== */
    .assignee-selector{position:relative}
    .assignee-input{width:100%}
    .assignee-dropdown{
      position:absolute; top:100%; left:0; right:0; z-index:100;
      background:var(--control-bg); border:1px solid var(--control-border); border-radius:.6rem;
      max-height:200px; overflow-y:auto; box-shadow:var(--control-shadow);
      margin-top:.2rem; display:none;
    }
    .assignee-dropdown.show{display:block}
    .assignee-option{
      padding:.5rem .7rem; cursor:pointer; display:flex; align-items:center; gap:.5rem;
      border-bottom:1px solid var(--control-border);
    }
    .assignee-option:hover{background:var(--accent-soft)}
    .assignee-option:last-child{border-bottom:none}
    .assignee-option img{width:24px; height:24px; border-radius:50%}
    .selected-assignees{display:flex; gap:.35rem; flex-wrap:wrap; margin-top:.35rem}
    .assignee-badge{
      background:var(--accent-soft); border:1px solid var(--border); border-radius:999px;
      padding:.25rem .5rem; font-size:.85rem; display:flex; align-items:center; gap:.35rem;
    }
    .assignee-badge button{
      background:none; border:none; color:var(--fg); cursor:pointer; padding:0; font-weight:bold;
      padding-left:.25rem;
    }
    .assignee-badge button:hover{color:var(--deic-blue)}

    /* ==== Label selection in story form ==== */
    .selected-story-labels{
      display:flex; gap:.35rem; flex-wrap:wrap; margin-bottom:.5rem;
    }
    .selected-story-labels p{
      margin:0; font-size:.85rem; color:var(--muted);
    }
    .available-story-labels{
      display:flex; flex-wrap:wrap; gap:.4rem;
    }
    .label-select-btn{
      display:inline-flex; align-items:center; gap:.35rem;
      padding:.4rem .7rem; border-radius:6px; border:1px solid;
      font-size:.8rem; font-weight:500; cursor:pointer;
      transition:all 0.2s ease; background:color-mix(in oklab, white 90%, currentColor);
      color:var(--fg); border-color:currentColor;
    }
    .label-select-btn:hover{
      filter:brightness(0.95);
      transform:translateY(-1px);
      box-shadow:0 2px 8px rgba(0,0,0,.12);
    }

    /* ==== Label filters ==== */
    .filter-group{
      margin-top:.5rem; border-top:1px solid var(--control-border); padding:.5rem;
      background:color-mix(in oklab, var(--accent) 3%, var(--control-bg)); border-radius:0.6rem;
      border:1px solid var(--control-border); max-height:none; overflow:visible; transition:max-height 0.3s ease;
    }
    .filter-group.collapsed{
      max-height:50px; overflow:hidden;
    }
    .filter-group h4{
      margin:0 0 .4rem; font-size:.75rem; color:var(--deic-blue); font-weight:700;
      text-transform:uppercase; letter-spacing:0.5px; display:flex; align-items:center; gap:.25rem; justify-content:space-between;
    }
    .filter-group h4::before{content:'üè∑Ô∏è'; font-size:0.85rem;}
    .filter-toggle-btn{
      background:none; border:none; color:var(--fg); cursor:pointer; font-size:.8rem; padding:0;
      display:inline-flex; align-items:center; gap:.2rem; transition:all 0.2s ease;
    }
    .filter-toggle-btn:hover{color:var(--accent);}
    .filter-reset-btn{
      background:none; border:none; color:var(--muted); cursor:pointer; font-size:.7rem;
      padding:.2rem .4rem; border-radius:.3rem; transition:all 0.2s ease;
    }
    .filter-reset-btn:hover{color:var(--fg); background:color-mix(in oklab, var(--fg) 10%, var(--control-bg));}
    .filter-category{
      margin-bottom:.6rem; padding-bottom:.6rem; border-bottom:1px solid var(--control-border);
    }
    .filter-category:last-child{margin-bottom:0; padding-bottom:0; border-bottom:none;}
    .filter-category strong{
      display:block; font-size:.7rem; color:var(--muted); text-transform:uppercase;
      letter-spacing:0.3px; margin-bottom:.3rem; font-weight:600;
    }
    .filter-options{
      display:flex; flex-wrap:wrap; gap:.3rem; align-items:flex-start;
    }
    .filter-checkbox{
      display:inline-block; font-size:.75rem; cursor:pointer;
      padding:.3rem .6rem; border-radius:20px; transition:all 0.2s ease;
      background:color-mix(in oklab, var(--accent) 12%, var(--control-bg));
      border:1px solid color-mix(in oklab, var(--accent) 25%, var(--border));
      color:var(--fg);
    }
    .filter-checkbox:hover{
      background:color-mix(in oklab, var(--accent) 20%, var(--control-bg));
      border-color:var(--accent);
    }
    .filter-checkbox input{
      display:none;
    }
    .filter-checkbox label{
      margin:0; cursor:pointer; user-select:none; display:inline;
    }
    .filter-checkbox input:checked + label{
      font-weight:600; color:var(--accent-contrast);
    }
    .filter-checkbox input:checked{
      accent-color:var(--deic-green);
    }
    .filter-checkbox:has(input:checked){
      background:var(--accent);
      border-color:var(--accent);
      color:var(--accent-contrast);
    }

    /* ==== Preview panel (slides from right) ==== */
    .preview-overlay{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; z-index:100; transition:opacity 0.3s ease; backdrop-filter:blur(2px);}
    .preview-overlay.show{display:block; opacity:1;}
    .preview-drawer{position:fixed; top:0; right:0; height:100vh; max-height:100vh; width:100%; max-width:450px; background:var(--control-bg); color:var(--fg); border-left:1px solid var(--control-border); box-shadow:-8px 0 32px rgba(0,0,0,.25); display:none; flex-direction:column; z-index:101; transform:translateX(100%); transition:transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);}
    .preview-drawer.show{display:flex; transform:translateX(0);}
    
    .preview-drawer header{
      background:var(--control-bg);
      border-bottom:1px solid var(--control-border); padding:1rem .9rem; display:flex; align-items:flex-start; justify-content:space-between; gap:.75rem; flex-shrink:0;
    }
    .preview-drawer h2{margin:0 0 0.3rem; font-size:1.2rem; color:var(--fg); font-weight:700;}
    .preview-header-meta{display:flex; gap:.6rem; flex-wrap:wrap; font-size:.75rem;}
    .preview-meta-badge{
      display:inline-flex; align-items:center; gap:.3rem; background:color-mix(in oklab, var(--accent) 20%, var(--fg)); 
      color:var(--fg); padding:.3rem .5rem; border-radius:999px; font-weight:600; white-space:nowrap;
    }
    .preview-drawer .close-btn{
      background:none; border:none; font-size:1.8rem; cursor:pointer; color:var(--muted); padding:0;
      width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:.4rem;
      transition:all 0.2s ease; flex-shrink:0;
    }
    .preview-drawer .close-btn:hover{color:var(--fg); background:color-mix(in oklab, var(--fg) 10%, var(--control-bg));}
    
    .preview-drawer .content{
      flex:1; overflow-y:auto; padding:1rem 0.9rem;
    }
    
    .preview-section{
      margin-bottom:1.2rem; background:transparent;
      border:none; border-bottom:1px solid var(--control-border); border-radius:0; padding:.75rem 0; transition:all 0.2s ease;
    }
    .preview-section:hover{border-color:var(--control-border);}
    .preview-section h3{
      margin:0 0 .5rem; font-size:.7rem; color:var(--muted); font-weight:600;
      text-transform:uppercase; letter-spacing:0.5px; display:flex; align-items:center; gap:.3rem;
    }
    .preview-section h3::before{content:''; display:none;}
    .preview-section p{margin:0; line-height:1.6; font-size:.85rem; color:var(--fg);}
    
    .preview-story-line{
      font-size:.9rem; font-style:italic; color:var(--fg); line-height:1.6;
      padding:.6rem; background:transparent;
      border-left:2px solid var(--muted); border-radius:0; margin-bottom:.8rem;
    }
    
    .preview-rgb-grid{
      display:grid; grid-template-columns:1fr 1fr 1fr; gap:.5rem; margin:0;
    }
    .preview-rgb-item{
      background:transparent; border:none; border-bottom:1px solid var(--control-border);
      padding:.5rem 0; border-radius:0; text-align:center;
    }
    .preview-rgb-item h4{margin:0 0 .3rem; font-size:.65rem; color:var(--muted); text-transform:uppercase; font-weight:600; letter-spacing:0.3px;}
    .preview-rgb-item p{margin:0; font-size:.75rem; color:var(--fg); font-weight:500;}
    
    .preview-meta{
      display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); gap:.75rem; margin:0;
    }
    .preview-meta-item{
      display:flex; flex-direction:column; gap:.35rem; background:transparent;
      padding:.5rem 0; border-radius:0; border:none; border-bottom:1px solid var(--control-border);
    }
    .preview-meta-label{font-size:.7rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.3px; font-weight:700;}
    .preview-meta-value{font-size:.9rem; color:var(--fg); font-weight:600;}
    
    .preview-labels{display:flex; gap:.3rem; flex-wrap:wrap; margin:0;}
    .preview-label{background:color-mix(in oklab, var(--deic-green) 85%, #000); color:#fff; border:1px solid color-mix(in oklab, var(--deic-green) 70%, #000); border-radius:999px; padding:.2rem .5rem; font-size:.7rem; font-weight:600;}
    
    .preview-assignees-list{
      display:flex; align-items:center; gap:.5rem; margin:0;
    }
    .preview-assignees-list img{
      width:32px; height:32px; border-radius:50%; border:2px solid var(--accent);
    }
    
    .preview-footer{
      border-top:1px solid var(--control-border); padding:.75rem .9rem; display:flex; gap:.4rem; flex-wrap:wrap; justify-content:flex-end; background:var(--control-bg);
    }
    .preview-footer a{
      display:inline-flex; align-items:center; gap:.3rem; padding:.5rem .8rem; background:var(--accent); color:var(--accent-contrast); border-radius:.5rem; text-decoration:none; font-weight:600; cursor:pointer; transition:all 0.2s ease; border:none; font-size:.85rem;
    }
    .preview-footer a:hover{filter:brightness(1.08); transform:translateY(-2px);}

    @media (max-width:600px){
      .preview-rgb-grid{ grid-template-columns:1fr; }
      .preview-meta{ grid-template-columns:1fr 1fr; }
      .preview-drawer .content{ padding:1rem 0.75rem; }
      .preview-drawer{ max-width:100%; }
    }
    @page { size: A4; margin: 16mm; }
    @media print {
      header, .controls, .status, .load-more, footer, .modal-backdrop, .preview-overlay, .preview-drawer { display: none !important; }
      body { background: #fff; }
      main { padding: 0 }
      .grid { grid-template-columns: 1fr; gap: .8rem; }
      .card { box-shadow: none; border-color: #ddd; }
      a[href]::after { content: " (" attr(href) ")"; font-size: .8em; color: #888; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="bar" role="navigation" aria-label="Top bar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>User Story Library</h1>
            <p class="tagline">A FAIR use case is a concrete description of who needs what kind of data, for what purpose, and under what conditions.</p>
          </div>
        </div>
        <div class="cta-row">
          <button id="theme-toggle" class="theme-toggle" title="Toggle dark mode">üåô</button>
          <button id="open-modal" class="button-link">New Story</button>
          <button id="export" class="button-link secondary">Export CSV</button>
          <button id="print" class="button-link secondary">Print / Save PDF</button>
        </div>
      </div>

      <div class="controls" aria-label="Filters and configuration">
        <div class="controls-row">
          <div>
            <label for="search">Search</label>
            <input id="search" type="text" placeholder="Search title, story, context or #number‚Ä¶" />
          </div>
          <div>
            <label for="state">State</label>
            <select id="state">
              <option value="open" selected>Open</option>
              <option value="closed">Closed</option>
              <option value="all">All</option>
            </select>
          </div>
          <div class="inline" style="align-items:end">
            <button id="refresh" class="primary">Refresh</button>
            <button id="toggle-token" aria-expanded="false" aria-controls="token-box">Token</button>
          </div>
          <div class="inline" style="align-items:end">
            <label class="inline" style="gap:.4rem" title="Show only issues that contain a valid 'As a‚Ä¶, I want to‚Ä¶, so that I can‚Ä¶' sentence">
              <input id="only-template" type="checkbox" checked />
              Only valid stories
            </label>
          </div>
          <div class="inline" style="align-items:end">
            <small>Backend: <a href="https://github.com/BrigitaPVoll/User_Story_Library" target="_blank" rel="noopener">BrigitaPVoll/User_Story_Library</a></small>
          </div>
        </div>

        <div id="token-box" class="token-box">
          <label for="token">GitHub Token (optional, required for creating issues)</label>
          <input id="token" type="password" placeholder="ghp_‚Ä¶ (classic) or fine-grained token" />
          <div class="notice">
            Stored locally in your browser (localStorage) to raise API limits and enable issue creation.
            Docs: <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens" target="_blank" rel="noopener">PATs</a>,
            <a href="https://stackoverflow.com/questions/63906613/minimal-set-of-scopes-to-push-to-github-using-an-access-token" target="_blank" rel="noopener">scopes</a>
          </div>
        </div>

        <div id="label-filters" class="filter-group">
          <h4>Filter by Labels</h4>
          
          <div class="filter-category">
            <strong>Contact Consent</strong>
            <div class="filter-options">
              <div class="filter-checkbox">
                <input type="checkbox" id="filter-consent-yes" value="Contact consent>YES" />
                <label for="filter-consent-yes">YES</label>
              </div>
              <div class="filter-checkbox">
                <input type="checkbox" id="filter-consent-no" value="Contact consent>NO" />
                <label for="filter-consent-no">NO</label>
              </div>
            </div>
          </div>

          <div class="filter-category">
            <strong>Domain</strong>
            <div class="filter-options">
              <div class="filter-checkbox">
                <input type="checkbox" value="Domain>Agricultural Sciences" />
                <label>Agricultural Sciences</label>
              </div>
              <div class="filter-checkbox">
                <input type="checkbox" value="Domain>Domain agnostic" />
                <label>Domain agnostic</label>
              </div>
              <div class="filter-checkbox">
                <input type="checkbox" value="Domain>Engineering and Technology" />
                <label>Engineering and Technology</label>
              </div>
              <div class="filter-checkbox">
                <input type="checkbox" value="Domain>Humanities" />
                <label>Humanities</label>
              </div>
              <div class="filter-checkbox">
                <input type="checkbox" value="Domain>Medical and Health Sciences" />
                <label>Medical and Health Sciences</label>
              </div>
              <div class="filter-checkbox">
                <input type="checkbox" value="Domain>Natural Sciences" />
                <label>Natural Sciences</label>
              </div>
              <div class="filter-checkbox">
                <input type="checkbox" value="Domain>Social Sciences" />
                <label>Social Sciences</label>
              </div>
            </div>
          </div>

          <div class="filter-category">
            <strong>Institution</strong>
            <div class="filter-options">
              <div class="filter-checkbox">
                <input type="checkbox" value="Institution>Aalborg University" />
                <label>Aalborg University</label>
              </div>
              <div class="filter-checkbox">
                <input type="checkbox" value="Institution>Aarhus University" />
                <label>Aarhus University</label>
              </div>
              <div class="filter-checkbox">
                <input type="checkbox" value="Institution>Copenhagen Business School (CBS)" />
                <label>Copenhagen Business School (CBS)</label>
              </div>
              <div class="filter-checkbox">
                <input type="checkbox" value="Institution>IT University of Copenhagen" />
                <label>IT University of Copenhagen</label>
              </div>
              <div class="filter-checkbox">
                <input type="checkbox" value="Institution>Roskilde University" />
                <label>Roskilde University</label>
              </div>
              <div class="filter-checkbox">
                <input type="checkbox" value="Institution>Technical University of Denmark (DTU)" />
                <label>Technical University of Denmark (DTU)</label>
              </div>
              <div class="filter-checkbox">
                <input type="checkbox" value="Institution>University of Copenhagen" />
                <label>University of Copenhagen</label>
              </div>
              <div class="filter-checkbox">
                <input type="checkbox" value="Institution>University of Southern Denmark (SDU)" />
                <label>University of Southern Denmark (SDU)</label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="status" id="status" aria-live="polite">
        <span id="rate" class="rate" title="GitHub REST API rate limit">API ‚Ä¶</span>
      </div>
      <section id="stories" class="grid" aria-label="User stories list"></section>
      <div class="empty" id="empty" style="display:none;">No user stories found.</div>
      <div class="error" id="error" style="display:none;"></div>

      <div class="load-more" style="display:flex; justify-content:center; margin-top:1rem;">
        <button id="more" style="display:none;">Load more</button>
      </div>
    </div>
  </main>

  <footer>
    <div class="wrap"><small>Powered by GitHub Issues ‚Ä¢ DeiC-inspired UI</small></div>
  </footer>

  <!-- ==== Modal: New User Story (Create GitHub Issue) ==== -->
  <div id="backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal">
      <header>
        <div class="wrap">
          <h2 id="modal-title">New User Story</h2>
          <p class="notice">Creates a GitHub Issue directly in <strong>BrigitaPVoll/User_Story_Library</strong>.</p>
        </div>
      </header>
      <div class="wrap">
        <form id="story-form">
          <div class="grid-form">
            <div class="full">
              <label for="title">Title (required)</label>
              <input id="title" type="text" placeholder="Short descriptive title" required />
            </div>

            <div>
              <label for="role">As a‚Ä¶ (role)</label>
              <input id="role" type="text" placeholder="e.g., conservation biologist" />
            </div>
            <div>
              <label for="goal">I want to‚Ä¶ (goal)</label>
              <input id="goal" type="text" placeholder="e.g., reuse butterfly observation data" />
            </div>

            <div class="full">
              <label for="benefit">‚Ä¶so that I can‚Ä¶ (benefit)</label>
              <input id="benefit" type="text" placeholder="e.g., study changes in biodiversity across landscapes" />
            </div>

            <div class="full">
              <label for="context">Additional context</label>
              <textarea id="context" placeholder="Any other context about the user story here."></textarea>
            </div>

            <div>
              <label>Contact consent</label>
              <select id="consent">
                <option value="Yes">Yes</option>
                <option value="No">No</option>
                <option value="N/A" selected>N/A</option>
              </select>
            </div>

            <div class="full">
              <label>Labels (Click to select)</label>
              <div id="label-selection-ui" style="display:flex; flex-direction:column; gap:.75rem;"></div>
            </div>

            <div class="full">
              <label for="assignees-input">Assign to GitHub User (optional)</label>
              <div class="assignee-selector">
                <input id="assignees-input" class="assignee-input" type="text" placeholder="Search GitHub users‚Ä¶" />
                <div id="assignees-dropdown" class="assignee-dropdown"></div>
              </div>
              <div id="selected-assignees" class="selected-assignees"></div>
            </div>
          </div>

          <div class="actions">
            <button type="button" id="cancel-modal">Cancel</button>
            <button type="submit" class="primary">Create Story</button>
          </div>

          <p class="notice" style="margin-top:.5rem;">
            Requires a GitHub token (set in <strong>Token</strong>) with permission to create issues.
            Public repo: classic <code>public_repo</code> or fine‚Äëgrained token with <em>Contents: Read &amp; write</em> on this repo.
            See <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens" target="_blank" rel="noopener">docs</a>.
          </p>
        </form>
      </div>
    </div>
  </div>

  <!-- ==== Preview Drawer: Story Details (slides up from bottom) ==== -->
  <div id="preview-overlay" class="preview-overlay"></div>
  <div id="preview-drawer" class="preview-drawer">
    <header>
      <div>
        <h2 id="preview-title"></h2>
        <div class="preview-header-meta">
          <span class="preview-meta-badge" id="preview-header-number"></span>
          <span class="preview-meta-badge" id="preview-header-state"></span>
          <span class="preview-meta-badge" id="preview-header-consent"></span>
        </div>
      </div>
      <button id="preview-close-btn" class="close-btn">‚úï</button>
    </header>
    <div class="content">
      <div class="preview-story-line" id="preview-story-line"></div>
      
      <div id="preview-role-goal-benefit" class="preview-rgb-grid"></div>

      <div id="preview-context-section" class="preview-section" style="display:none;">
        <h3>Context</h3>
        <p id="preview-context"></p>
      </div>

      <div class="preview-section">
        <h3>Details</h3>
        <div class="preview-meta">
          <div class="preview-meta-item">
            <div class="preview-meta-label">Updated</div>
            <div class="preview-meta-value" id="preview-updated"></div>
          </div>
        </div>
      </div>

      <div class="preview-section">
        <h3>Labels</h3>
        <div id="preview-labels" class="preview-labels"></div>
      </div>

      <div id="preview-assignees-section" class="preview-section" style="display:none;">
        <h3>Assignees</h3>
        <div id="preview-assignees" class="preview-assignees-list"></div>
      </div>
    </div>
    <div class="preview-footer">
      <a id="preview-github-link" target="_blank" rel="noopener">‚Üí View on GitHub</a>
    </div>
  </div>

  <script>
    // ---------- Configuration ----------
    const OWNER = 'BrigitaPVoll';
    const REPO  = 'User_Story_Library';
    const PER_PAGE = 20;

    // ---------- State ----------
    let currentPage = 1;
    let lastBatch = [];
    let accumulated = [];
    let selectedAssignees = [];
    let availableUsers = [];
    let availableLabels = [];  // All labels from repo
    let selectedLabels = [];  // State for selected label filters
    let selectedStoryLabels = [];  // State for labels selected in new story form

    // ---------- DOM ----------
    const $ = sel => document.querySelector(sel);
    const storiesEl = $('#stories');
    const statusEl  = $('#status');
    const emptyEl   = $('#empty');
    const errorEl   = $('#error');
    const moreBtn   = $('#more');

    const tokenBox = $('#token-box');
    const tokenInput = $('#token');

    const backdrop = $('#backdrop');
    const openModalBtn = $('#open-modal');
    const cancelModalBtn = $('#cancel-modal');
    const storyForm = $('#story-form');
    const rateEl = $('#rate');

    const assigneesInput = $('#assignees-input');
    const assigneesDropdown = $('#assignees-dropdown');
    const selectedAssigneesEl = $('#selected-assignees');

    const previewOverlay = $('#preview-overlay');
    const previewDrawer = $('#preview-drawer');
    const previewCloseBtn = $('#preview-close-btn');

    const themeToggleBtn = $('#theme-toggle');

    // ---------- Utilities ----------
    function escapeHTML(str){
      return String(str ?? '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[s]);
    }
    function fmtDate(iso){
      try{
        const d = new Date(iso);
        return new Intl.DateTimeFormat('en', {dateStyle:'medium', timeStyle:'short'}).format(d);
      }catch{ return iso || '' }
    }
    function setStatus(text){ statusEl.firstChild ? statusEl.firstChild.textContent = text || '' : (statusEl.textContent = text || ''); }
    function showError(msg){
      errorEl.style.display='block';
      errorEl.textContent = 'Error: ' + msg;
      setStatus('');
    }
    function updateRateFromHeaders(h){
      try{
        const limit = h.get('x-ratelimit-limit');
        const remaining = h.get('x-ratelimit-remaining');
        const reset = h.get('x-ratelimit-reset');
        if(limit && remaining && rateEl){
          const secs = reset ? Math.max(0, parseInt(reset,10) - Math.floor(Date.now()/1000)) : null;
          const mins = secs!=null ? Math.ceil(secs/60) : null;
          rateEl.textContent = `API ${remaining}/${limit}${mins!=null ? ` (resets ~${mins}m)` : ''}`;
        }
      }catch{}
    }

    // ---------- Parse template from issue body ----------
    function parseStory(body){
      const raw = body || '';
      const lines = raw.split(/\r?\n/);

      const storyLineIdx = lines.findIndex(l => /^(\s*\*\*)?\s*As a\b/i.test(l));
      const storyLine = storyLineIdx >= 0 ? lines[storyLineIdx].replace(/^\s*\*\*|\*\*\s*$/g,'').trim() : '';

      let role='', goal='', benefit='';
      const m = storyLine.replace(/\*\*/g,'')
        .match(/As a\s+(.*?)[,;]?\s*I\s+want\s+to\s+(.*?)[,;]?\s*so\s+that\s+I\s+can\s+(.*?)(?:\.|$)/i);
      if (m){ role=m[1].trim(); goal=m[2].trim(); benefit=m[3].trim(); }

      const ctxHeaderIdx = lines.findIndex(l => /additional\s+context/i.test(l));
      let context = '';
      if (ctxHeaderIdx >= 0){
        const nextHeaderIdx = lines.slice(ctxHeaderIdx+1).findIndex(l => /can\s+we\s+contact\s+you/i.test(l));
        const end = nextHeaderIdx >= 0 ? ctxHeaderIdx + 1 + nextHeaderIdx : lines.length;
        context = lines.slice(ctxHeaderIdx+1, end).join('\n').trim();
        context = context.replace(/^\s*\*\*|\*\*\s*$/gm,'').trim();
      }

      const consentIdx = lines.findIndex(l => /can\s+we\s+contact\s+you/i.test(l));
      let consent = 'N/A';
      if (consentIdx >= 0){
        const answerLine = (lines[consentIdx+1] || '').trim();
        const yn = (answerLine.match(/yes|no/i) || [])[0];
        if (yn) consent = /^yes$/i.test(yn) ? 'Yes' : 'No';
      }

      return { storyLine, role, goal, benefit, context, consent };
    }

    // ---------- GitHub API ----------
    function buildIssuesURL({state, page}){
      const base = `https://api.github.com/repos/${encodeURIComponent(OWNER)}/${encodeURIComponent(REPO)}/issues`;
      const params = new URLSearchParams({
        state: state || 'open',
        per_page: String(PER_PAGE),
        page: String(page || 1)
      });
      return `${base}?${params}`;
    }

    async function fetchIssues({append=false}={}){
      const state = $('#state').value;
      const url = buildIssuesURL({state, page: currentPage});
      const headers = { 'Accept': 'application/vnd.github+json' };
      const token = localStorage.getItem('GITHUB_TOKEN') || tokenInput.value.trim();
      if (token) headers['Authorization'] = `Bearer ${token}`;

      try{
        if(!append){ setStatus('Loading user stories‚Ä¶ '); errorEl.style.display='none'; }
        const res = await fetch(url, { headers });
        updateRateFromHeaders(res.headers);
        if(!res.ok){
          if(res.status === 401) throw new Error('401 Unauthorized ‚Äî invalid or missing token');
          if(res.status === 403) throw new Error('403 Forbidden or rate-limited ‚Äî add a token or wait and retry');
          const text = await res.text();
          throw new Error(`${res.status} ${res.statusText} ‚Äî ${text}`);
        }
        const data = await res.json();
        const issues = data.filter(it => !it.pull_request);

        lastBatch = issues;
        if (append){ accumulated = accumulated.concat(issues); }
        else { accumulated = issues; }

        renderIssues(accumulated);
        setStatus(`Loaded ${accumulated.length} user stor${accumulated.length===1?'y':'ies'}`);
        moreBtn.style.display = issues.length === PER_PAGE ? 'inline-block' : 'none';
      }catch(err){ showError(err.message); }
    }

    // ---------- Fetch GitHub collaborators/users ----------
    async function fetchRepositoryUsers(){
      const token = localStorage.getItem('GITHUB_TOKEN') || tokenInput.value.trim();
      if (!token) return;

      const url = `https://api.github.com/repos/${OWNER}/${REPO}/collaborators`;
      const headers = {
        'Accept': 'application/vnd.github+json',
        'Authorization': `Bearer ${token}`
      };

      try {
        const res = await fetch(url, { headers });
        if (res.ok) {
          availableUsers = await res.json();
        }
      } catch (err) {
        console.warn('Could not fetch users:', err);
      }
    }

    // Fetch all available labels from the repository
    async function fetchRepositoryLabels(){
      const url = `https://api.github.com/repos/${OWNER}/${REPO}/labels?per_page=100`;
      const headers = {
        'Accept': 'application/vnd.github+json'
      };

      try {
        const res = await fetch(url, { headers });
        if (res.ok) {
          availableLabels = await res.json();
          // Dynamically rebuild the filter UI with fetched labels
          renderLabelFilters();
          // Render label selection in the modal
          renderLabelSelection();
        }
      } catch (err) {
        console.warn('Could not fetch labels:', err);
      }
    }

    // Render label filters dynamically
    function renderLabelFilters(){
      const filterGroup = $('#label-filters');
      if (!filterGroup) return;
      
      // Group labels by category (Contact consent, Domain, Institution, etc.)
      const grouped = {};
      availableLabels.forEach(label => {
        const name = label.name;
        const category = name.split('>')[0];
        if (!grouped[category]) grouped[category] = [];
        grouped[category].push(label);
      });

      // Rebuild filter HTML with label buttons (no checkboxes)
      let html = `<div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
        <h4>üè∑Ô∏è Filter by Labels</h4>
        <div style="display:flex; gap:.2rem;">
          <button type="button" class="filter-toggle-btn" id="filter-toggle" title="Toggle filters">‚ñº</button>
          ${selectedLabels.length > 0 ? '<button type="button" class="filter-reset-btn" id="filter-reset" title="Reset filters">Reset</button>' : ''}
        </div>
      </div>`;
      
      for (const [category, labels] of Object.entries(grouped)) {
        html += `<div class="filter-category"><strong>${escapeHTML(category)}</strong><div class="filter-options">`;
        labels.forEach(label => {
          const value = label.name;
          const isSelected = selectedLabels.includes(value);
          html += `<button type="button" class="filter-checkbox" data-label="${escapeHTML(value)}" 
                    style="${isSelected ? 'background:var(--accent); color:var(--accent-contrast); border-color:var(--accent);' : ''}">
            ${escapeHTML(value.split('>').pop())}
          </button>`;
        });
        html += '</div></div>';
      }
      
      // Replace the content
      filterGroup.innerHTML = html;
      
      // Attach toggle listener
      const toggleBtn = filterGroup.querySelector('#filter-toggle');
      if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
          filterGroup.classList.toggle('collapsed');
          toggleBtn.textContent = filterGroup.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
        });
      }

      // Attach reset listener
      const resetBtn = filterGroup.querySelector('#filter-reset');
      if (resetBtn) {
        resetBtn.addEventListener('click', () => {
          selectedLabels = [];
          renderLabelFilters();
          renderIssues(accumulated);
        });
      }
      
      // Re-attach event listeners to buttons
      const buttons = filterGroup.querySelectorAll('.filter-checkbox');
      buttons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const labelValue = btn.dataset.label;
          if (selectedLabels.includes(labelValue)) {
            selectedLabels = selectedLabels.filter(l => l !== labelValue);
          } else {
            selectedLabels.push(labelValue);
          }
          renderLabelFilters();  // Re-render to update button styles
          renderIssues(accumulated);
        });
      });
    }

    // Render label selection in the create story modal
    function renderLabelSelection(){
      const labelSelectionEl = $('#label-selection-ui');
      if (!labelSelectionEl) return;

      // Build HTML for selected labels and available labels
      let html = '<div class="selected-story-labels" id="selected-story-labels-list"></div>';
      html += '<div class="available-story-labels">';
      
      availableLabels.forEach(label => {
        const isSelected = selectedStoryLabels.includes(label.name);
        const textColor = parseInt(label.color, 16) > 0xffffff/2 ? '#000' : '#fff';
        const selectedStyle = isSelected ? `border-width:2px; border-color:var(--deic-green); box-shadow:0 0 0 3px color-mix(in oklab, var(--deic-green) 30%, transparent);` : '';
        html += `<button type="button" class="label-select-btn" data-label="${escapeHTML(label.name)}" 
                  style="background-color: #${label.color}; color: ${textColor}; ${selectedStyle}">
          ${escapeHTML(label.name)}
        </button>`;
      });
      html += '</div>';
      
      // Set all HTML at once
      labelSelectionEl.innerHTML = html;

      // Attach click handlers
      labelSelectionEl.querySelectorAll('.label-select-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const labelName = btn.dataset.label;
          if (selectedStoryLabels.includes(labelName)) {
            selectedStoryLabels = selectedStoryLabels.filter(l => l !== labelName);
          } else {
            selectedStoryLabels.push(labelName);
          }
          renderLabelSelection();  // Re-render to update visual feedback
          renderSelectedStoryLabels();
        });
      });
      
      renderSelectedStoryLabels();
    }

    // Render selected labels for new story
    function renderSelectedStoryLabels(){
      const selectedEl = $('#selected-story-labels-list');
      if (!selectedEl) return;
      
      if (selectedStoryLabels.length === 0) {
        selectedEl.innerHTML = '<p style="color:var(--muted); font-size:.85rem; margin:0;">No labels selected</p>';
        return;
      }

      selectedEl.innerHTML = selectedStoryLabels.map(labelName => {
        const label = availableLabels.find(l => l.name === labelName);
        if (!label) return '';
        return `
          <div class="assignee-badge" style="background:var(--accent-soft);">
            <span>${escapeHTML(labelName)}</span>
            <button type="button" data-label="${escapeHTML(labelName)}" style="background:none; border:none; color:inherit; cursor:pointer; padding:0; margin-left:.25rem; font-weight:bold;">√ó</button>
          </div>
        `;
      }).join('');

      selectedEl.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const labelName = btn.dataset.label;
          selectedStoryLabels = selectedStoryLabels.filter(l => l !== labelName);
          renderSelectedStoryLabels();
        });
      });
    }

    // ---------- Assignee selector UI ----------
    assigneesInput.addEventListener('input', async (e) => {
      const query = e.target.value.trim().toLowerCase();
      
      if (!query) {
        assigneesDropdown.classList.remove('show');
        return;
      }

      if (availableUsers.length === 0) {
        await fetchRepositoryUsers();
      }

      const filtered = availableUsers.filter(u => 
        u.login.toLowerCase().includes(query) && !selectedAssignees.find(s => s.login === u.login)
      );

      assigneesDropdown.innerHTML = filtered.map(u => `
        <div class="assignee-option" data-login="${u.login}" data-avatar="${u.avatar_url}">
          <img src="${u.avatar_url}" alt="${u.login}" />
          <span>${escapeHTML(u.login)}</span>
        </div>
      `).join('');

      if (filtered.length > 0) {
        assigneesDropdown.classList.add('show');
        assigneesDropdown.querySelectorAll('.assignee-option').forEach(opt => {
          opt.addEventListener('click', () => {
            const login = opt.dataset.login;
            const avatar = opt.dataset.avatar;
            selectedAssignees.push({ login, avatar_url: avatar });
            assigneesInput.value = '';
            assigneesDropdown.classList.remove('show');
            renderSelectedAssignees();
          });
        });
      } else {
        assigneesDropdown.classList.remove('show');
      }
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.assignee-selector')) {
        assigneesDropdown.classList.remove('show');
      }
    });

    function renderSelectedAssignees(){
      selectedAssigneesEl.innerHTML = selectedAssignees.map(a => `
        <div class="assignee-badge">
          <img src="${a.avatar_url}" alt="${a.login}" style="width:20px; height:20px; border-radius:50%;" />
          <span>${escapeHTML(a.login)}</span>
          <button type="button" data-login="${a.login}" style="background:none; border:none; color:inherit; cursor:pointer; padding:0; margin-left:.25rem; font-weight:bold;">√ó</button>
        </div>
      `).join('');

      selectedAssigneesEl.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const login = btn.dataset.login;
          selectedAssignees = selectedAssignees.filter(a => a.login !== login);
          renderSelectedAssignees();
        });
      });
    }

    // ---------- Preview drawer functions ----------
    function openPreview(issue) {
      const parsed = parseStory(issue.body);
      const labels = (issue.labels||[]).map(l=>l.name).sort();
      const assignees = (issue.assignees||[]);
      const updated = issue.updated_at ? fmtDate(issue.updated_at) : 'N/A';
      const title = (issue.title && issue.title.trim()) || parsed.storyLine || `(issue #${issue.number})`;

      // Set header with title and metadata badges
      $('#preview-title').textContent = escapeHTML(title);
      $('#preview-header-number').textContent = `üìå Issue #${issue.number}`;
      $('#preview-header-state').textContent = `${issue.state === 'open' ? 'üü¢' : 'üî¥'} ${escapeHTML(issue.state || 'N/A')}`;
      const consentIcon = parsed.consent === 'Yes' ? '‚úÖ' : (parsed.consent === 'No' ? '‚ùå' : '‚ùì');
      $('#preview-header-consent').textContent = `${consentIcon} ${escapeHTML(parsed.consent || 'N/A')}`;

      // Set story line
      const storyEl = $('#preview-story-line');
      if (parsed.storyLine) {
        storyEl.textContent = escapeHTML(parsed.storyLine);
      } else {
        storyEl.textContent = '(No story line provided)';
        storyEl.style.opacity = '0.7';
      }

      // Set role, goal, benefit grid
      const rgbEl = $('#preview-role-goal-benefit');
      const roleGoalBenefit = [
        { label: 'Role', icon: 'üë§', value: parsed.role },
        { label: 'Goal', icon: 'üéØ', value: parsed.goal },
        { label: 'Benefit', icon: '‚≠ê', value: parsed.benefit }
      ];
      rgbEl.innerHTML = roleGoalBenefit.map(item => `
        <div class="preview-rgb-item">
          <h4>${item.icon} ${escapeHTML(item.label)}</h4>
          <p>${item.value ? escapeHTML(item.value) : '(not provided)'}</p>
        </div>
      `).join('');

      // Set context
      const ctxSection = $('#preview-context-section');
      const ctxEl = $('#preview-context');
      if (parsed.context) {
        ctxEl.textContent = escapeHTML(parsed.context);
        ctxSection.style.display = 'block';
      } else {
        ctxSection.style.display = 'none';
      }

      // Set metadata
      $('#preview-updated').textContent = updated;

      // Set labels
      const labelsEl = $('#preview-labels');
      labelsEl.innerHTML = labels.length > 0 
        ? labels.map(name => `<span class="preview-label">${escapeHTML(name)}</span>`).join('')
        : '<span style="color:var(--muted); font-size:.85rem;">No labels</span>';

      // Set assignees
      const assigneesSection = $('#preview-assignees-section');
      const assigneesEl = $('#preview-assignees');
      if (assignees.length > 0) {
        assigneesEl.innerHTML = assignees.map(a=>`<img src="${a.avatar_url}" alt="${escapeHTML(a.login)}" title="${escapeHTML(a.login)}" />`).join('');
        assigneesSection.style.display = 'block';
      } else {
        assigneesSection.style.display = 'none';
      }

      // Set GitHub link
      $('#preview-github-link').href = issue.html_url;

      // Show the drawer
      previewOverlay.classList.add('show');
      previewDrawer.classList.add('show');
    }

    function closePreview() {
      previewOverlay.classList.remove('show');
      previewDrawer.classList.remove('show');
    }

    // ---------- Create issue (New Story) ----------
    function buildIssueBody({role, goal, benefit, context, consent}) {
      const line = (role || goal || benefit)
        ? `As a ${role || '_____'}, I want to ${goal || '______'}, so that I can ${benefit || '________'}.`
        : '';
      return [
        'User Story',
        '',
        '**User story description, please follow the syntax below**',
        line,
        '',
        '**Additional context**',
        context || '',
        '',
        '**Can we contact you to participate in a future EOSC funded project on FAIR data management?**',
        (consent || 'N/A')
      ].join('\n');
    }

    async function createIssue({
      title, role, goal, benefit, context, consent, labels, assignees
    }) {
      const token = localStorage.getItem('GITHUB_TOKEN') || tokenInput.value.trim();
      if (!token) throw new Error('Missing token. Set Token in the header.');

      // Handle labels as array or string
      let labelNames;
      if (Array.isArray(labels)) {
        labelNames = labels.map(l => l.name || l).filter(Boolean);
      } else {
        labelNames = (labels || 'user-story').split(',').map(s => s.trim()).filter(Boolean);
      }

      const body = {
        title: title.trim(),
        body: buildIssueBody({role, goal, benefit, context, consent}),
        labels: labelNames,
        assignees: assignees.map(a => a.login)
      };

      // Call GitHub API directly
      const res = await fetch(
        `https://api.github.com/repos/BrigitaPVoll/User_Story_Library/issues`,
        { 
          method: 'POST', 
          headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/vnd.github+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body) 
        }
      );

      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.message || `${res.status} ${res.statusText}`);
      }
      return res.json();
    }

    // ---------- Rendering ----------
    function renderIssues(items){
      const q = ($('#search').value || '').toLowerCase().trim();
      const onlyTemplate = $('#only-template').checked;

      const filtered = items.filter(i => {
        const parsed = parseStory(i.body);
        const hasStory = parsed.storyLine && /As a\b/i.test(parsed.storyLine);
        if (onlyTemplate && !hasStory) return false;

        // Filter by selected labels
        if (selectedLabels.length > 0) {
          const issueLabels = (i.labels||[]).map(l=>l.name);
          const hasAllSelectedLabels = selectedLabels.every(selectedLabel =>
            issueLabels.includes(selectedLabel)
          );
          if (!hasAllSelectedLabels) return false;
        }

        if (!q) return true;
        const hay = [
          i.title || '',
          i.number,
          parsed.storyLine || '',
          parsed.context || '',
          (i.labels||[]).map(l=>l.name).join(' ')
        ].join(' ').toLowerCase();
        return hay.includes(q);
      });

      storiesEl.innerHTML = '';
      emptyEl.style.display = filtered.length ? 'none' : 'block';

      for (const i of filtered){
        const parsed = parseStory(i.body);
        const labels = (i.labels||[]).map(l=>l.name).sort();
        const assignees = (i.assignees||[]);
        const updated = i.updated_at ? fmtDate(i.updated_at) : '';
        const title = (i.title && i.title.trim()) || parsed.storyLine || `(issue #${i.number})`;

        const storyParts = (parsed.role || parsed.goal || parsed.benefit)
          ? `<div class="story-parts">
               ${parsed.role ? `<span class="story-part">Role: ${escapeHTML(parsed.role)}</span>`:''}
               ${parsed.goal ? `<span class="story-part">Goal: ${escapeHTML(parsed.goal)}</span>`:''}
               ${parsed.benefit ? `<span class="story-part">Benefit: ${escapeHTML(parsed.benefit)}</span>`:''}
             </div>` : '';

        const consentPill = parsed.consent === 'Yes' ? 'ok' : (parsed.consent === 'No' ? 'no' : 'na');

        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <h3><a href="${i.html_url}" target="_blank" rel="noopener">${escapeHTML(title)}</a></h3>
          <div class="meta">
            <span>#${i.number}</span><span>‚Ä¢</span>
            <span>${escapeHTML(i.state)}</span>
            ${updated ? `<span>‚Ä¢</span><span>Updated ${escapeHTML(updated)}</span>` : ''}
          </div>

          ${parsed.storyLine ? `<div class="desc">${escapeHTML(parsed.storyLine)}</div>`:''}
          ${storyParts}

          ${parsed.context ? `
            <div>
              <div class="meta" style="margin-top:.25rem;"><strong>Additional context</strong></div>
              <div class="desc" style="white-space:pre-wrap;">${escapeHTML(parsed.context)}</div>
            </div>` : ''}

          <div class="meta" style="margin-top:.35rem;">
            <span class="pill ${consentPill}">Contact consent: ${escapeHTML(parsed.consent)}</span>
          </div>

          <div class="meta">
            <div class="labels">
              ${labels.map(name => `<span class="label">${escapeHTML(name)}</span>`).join('')}
            </div>
          </div>

          ${assignees.length ? `
            <div class="meta assignees">
              <span>Assignees:</span>
              ${assignees.map(a=>`<img src="${a.avatar_url}" alt="${escapeHTML(a.login)}" />`).join('')}
            </div>` : ''}

          <div class="meta">
            <a href="${i.html_url}" target="_blank" rel="noopener">‚Üí Open in GitHub</a>
          </div>
        `;
        card.style.cursor = 'pointer';
        card.addEventListener('click', (e) => {
          if (e.target.tagName !== 'A') {
            openPreview(i);
          }
        });
        storiesEl.appendChild(card);
      }
    }

    // ---------- CSV export ----------
    function toCSV(items){
      const header = ["number","title","state","updated_iso","labels","role","goal","benefit","consent","context","url"];
      const rows = items.map(i => {
        const p = parseStory(i.body);
        const labels = (i.labels||[]).map(l=>l.name).join('|');
        const clean = s => (s||'').replace(/\r?\n/g,' ').trim();
        return [
          i.number,
          clean(i.title || p.storyLine || ''),
          i.state || '',
          i.updated_at || '',
          labels,
          clean(p.role),
          clean(p.goal),
          clean(p.benefit),
          p.consent || 'N/A',
          clean(p.context),
          i.html_url || ''
        ];
      });
      const escapeCell = v => {
        const s = String(v ?? '');
        return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      };
      const csv = [header.join(','), ...rows.map(r => r.map(escapeCell).join(','))].join('\n');
      return csv;
    }
    function downloadCSV(){
      const csv = toCSV(accumulated);
      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `user-stories_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
    }

    // ---------- Events ----------
    $('#refresh').addEventListener('click', () => {
      currentPage = 1;
      fetchIssues({append:false});
    });
    $('#state').addEventListener('change', () => {
      currentPage = 1;
      fetchIssues({append:false});
    });
    $('#search').addEventListener('input', () => renderIssues(accumulated));
    $('#only-template').addEventListener('change', () => renderIssues(accumulated));

    // Label filter event listeners
    const labelFilterCheckboxes = document.querySelectorAll('#label-filters input[type="checkbox"]');
    labelFilterCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        selectedLabels = [];
        labelFilterCheckboxes.forEach(cb => {
          if (cb.checked) {
            selectedLabels.push(cb.value);
          }
        });
        renderIssues(accumulated);
      });
    });

    $('#toggle-token').addEventListener('click', () => {
      const isOpen = tokenBox.style.display !== 'none';
      tokenBox.style.display = isOpen ? 'none' : 'grid';
      $('#toggle-token').setAttribute('aria-expanded', String(!isOpen));
    });
    $('#token').addEventListener('change', (e) => {
      const v = e.target.value.trim();
      if (v) localStorage.setItem('GITHUB_TOKEN', v);
    });

    $('#export').addEventListener('click', downloadCSV);
    $('#print').addEventListener('click', () => window.print());
    moreBtn.addEventListener('click', () => {
      currentPage += 1;
      fetchIssues({append:true});
    });

    // Preview drawer open/close
    previewCloseBtn.addEventListener('click', closePreview);
    previewOverlay.addEventListener('click', closePreview);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && previewDrawer.classList.contains('show')) {
        closePreview();
      }
    });

    // Theme toggle
    function toggleTheme() {
      const html = document.documentElement;
      const isDark = html.classList.contains('dark-mode');
      if (isDark) {
        html.classList.remove('dark-mode');
        localStorage.setItem('theme', 'light');
        themeToggleBtn.textContent = 'üåô';
        themeToggleBtn.title = 'Switch to dark mode';
      } else {
        html.classList.add('dark-mode');
        localStorage.setItem('theme', 'dark');
        themeToggleBtn.textContent = '‚òÄÔ∏è';
        themeToggleBtn.title = 'Switch to light mode';
      }
    }
    themeToggleBtn.addEventListener('click', toggleTheme);

    // Modal open/close
    openModalBtn.addEventListener('click', () => { 
      backdrop.style.display = 'flex';
      fetchRepositoryUsers();
      fetchRepositoryLabels();
    });
    cancelModalBtn.addEventListener('click', () => { 
      backdrop.style.display = 'none';
      selectedAssignees = [];
      selectedStoryLabels = [];
      renderSelectedAssignees();
      renderSelectedStoryLabels();
    });
    backdrop.addEventListener('click', (e) => { 
      if (e.target === backdrop) {
        backdrop.style.display = 'none';
        selectedAssignees = [];
        selectedStoryLabels = [];
        renderSelectedAssignees();
        renderSelectedStoryLabels();
      }
    });
    document.addEventListener('keydown', (e) => { 
      if (e.key === 'Escape') {
        backdrop.style.display = 'none';
        selectedAssignees = [];
        renderSelectedAssignees();
      }
    });

    // Create story -> GitHub Issue
    storyForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = $('#title').value.trim();
      const role = $('#role').value.trim();
      const goal = $('#goal').value.trim();
      const benefit = $('#benefit').value.trim();

      if (!title) { alert('Title is required'); return; }
      if (!role || !goal) { alert('Please provide at least the role and the goal.'); return; }

      const payload = {
        title,
        role,
        goal,
        benefit,
        context: $('#context').value.trim(),
        consent: $('#consent').value,
        labels: selectedStoryLabels,
        assignees: selectedAssignees
      };

      try {
        setStatus('Creating issue‚Ä¶ ');
        const issue = await createIssue(payload);
        setStatus('Issue created successfully.');
        backdrop.style.display = 'none';

        // Clear the form and re-render
        storyForm.reset();
        selectedAssignees = [];
        selectedStoryLabels = [];
        renderSelectedAssignees();
        renderSelectedStoryLabels();
        accumulated = [issue, ...accumulated];
        renderIssues(accumulated);
      } catch (err) {
        alert('Failed to create issue: ' + err.message);
        setStatus('');
      }
    });

    // ---------- Init ----------
    (function init(){
      // Restore theme preference
      const savedTheme = localStorage.getItem('theme');
      const html = document.documentElement;
      if (savedTheme === 'dark') {
        html.classList.add('dark-mode');
        themeToggleBtn.textContent = '‚òÄÔ∏è';
        themeToggleBtn.title = 'Switch to light mode';
      } else if (savedTheme === 'light') {
        html.classList.remove('dark-mode');
        themeToggleBtn.textContent = 'üåô';
        themeToggleBtn.title = 'Switch to dark mode';
      } else {
        // Auto-detect system preference
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          html.classList.add('dark-mode');
          themeToggleBtn.textContent = '‚òÄÔ∏è';
          themeToggleBtn.title = 'Switch to light mode';
        } else {
          themeToggleBtn.textContent = 'üåô';
          themeToggleBtn.title = 'Switch to dark mode';
        }
      }

      const saved = localStorage.getItem('GITHUB_TOKEN');
      if (saved) tokenInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
      currentPage = 1;
      fetchIssues({append:false});
    })();
  </script>
</body>
</html>
