<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>User Story Library Â· DeiC</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
/* ============================================================
   THEME â€” DeiC Light + Dark
============================================================ */
:root{
  --deic-green:#BFD730;
  --deic-blue:#16385D;

  --bg:#EEF2EC;
  --card:#FFFFFF;
  --border:#C9D3C2;

  --text:#14180F;
  --muted:#596368;

  --chip-bg:#E6EEDA;
  --chip-selected:#BFD730;
  --chip-selected-text:#000;

  --radius:14px;
  --shadow:0 4px 15px rgba(0,0,0,.10);
  --shadow-hover:0 10px 28px rgba(0,0,0,.14);
}

.dark{
  --bg:#0C1420;
  --card:#182234;
  --border:#2E3B52;
  --text:#ECF2FA;
  --muted:#AAB6C6;

  --chip-bg:#233149;
  --chip-selected:#BFD730;
  --chip-selected-text:#000;
}

/* BASE */
*{box-sizing:border-box}
body{
  margin:0; font-family:Inter,ui-sans-serif,system-ui;
  background:var(--bg); color:var(--text);
  transition:background .25s, color .25s;
}
.wrap{max-width:1100px;margin:0 auto;padding:0 1.25rem}

/* HEADER */
header{
  position:sticky;top:0;z-index:20;
  background:#fffffff0; backdrop-filter:blur(12px);
  border-bottom:3px solid var(--deic-green);
  box-shadow:var(--shadow);
}
.dark header{background:#131A28DD}

.header-row{
  display:flex;justify-content:space-between;align-items:center;
  padding:1rem 0;gap:1rem;flex-wrap:wrap;
}

.logo{
  width:42px;height:42px;border-radius:12px;
  background:conic-gradient(from 180deg,var(--deic-green),var(--deic-blue),#000,var(--deic-green));
  border:1px solid var(--border);
}

h1{margin:0;font-size:1.6rem;font-weight:800;color:var(--deic-blue)}
.dark h1{color:var(--deic-green)}

.btn{
  padding:.65rem 1rem;border:none;border-radius:var(--radius);
  font-weight:600;cursor:pointer;transition:.15s;
}
.btn-primary{background:var(--deic-green);color:#000}
.btn-secondary{background:var(--deic-blue);color:#fff}

/* FILTERS */
.filters{
  margin-top:1rem;background:var(--card);border:1px solid var(--border);
  border-radius:var(--radius);padding:1rem;box-shadow:var(--shadow);
}

.filter-top{
  display:grid;grid-template-columns:1fr auto auto auto;gap:.6rem;
}

input,select{
  padding:.65rem .75rem;border-radius:var(--radius);
  border:1px solid var(--border);background:var(--card);color:var(--text);
}

.facets{margin-top:1rem;display:flex;flex-direction:column;gap:1rem}

.facet{
  border:1px solid var(--border);border-radius:var(--radius);
  background:var(--card);
}
.facet-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:.6rem .8rem;cursor:pointer;
}
.facet-title{margin:0;font-weight:700;font-size:.95rem;color:var(--muted)}
.facet.collapsed .facet-body{max-height:0;padding-bottom:0}
.chip-row{display:flex;flex-wrap:wrap;gap:.45rem;margin-top:.5rem}

.chip{
  padding:.35rem .7rem;border-radius:999px;background:var(--chip-bg);
  border:1px solid var(--border);cursor:pointer;font-size:.82rem;
}
.chip.selected{
  background:var(--chip-selected);border-color:var(--chip-selected);
  color:var(--chip-selected-text);
}

/* GRID */
.grid{margin-top:1.5rem;display:grid;gap:1.25rem;
      grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
.card{
  background:var(--card);border:1px solid var(--border);
  border-radius:var(--radius);padding:1.25rem;box-shadow:var(--shadow);
  cursor:pointer;transition:.2s;
}
.card:hover{
  transform:translateY(-3px);box-shadow:var(--shadow-hover);
  border-color:var(--deic-green)
}

.labels{display:flex;flex-wrap:wrap;gap:.35rem}
.label{
  padding:.2rem .55rem;border-radius:999px;background:#E9F1D8;
  border:1px solid var(--border);font-size:.75rem;color:#213014;
}
.dark .label{background:#283752;color:#E9EFF8}

/* Preview Sheet */
#sheet-backdrop{
  position:fixed;inset:0;background:rgba(0,0,0,.35);
  display:none;z-index:90;
}
#sheet{
  position:fixed;left:0;right:0;bottom:-100%;
  background:var(--card);border-radius:24px 24px 0 0;
  padding:1.5rem;max-height:85vh;overflow-y:auto;transition:bottom .35s;
  z-index:100;box-shadow:0 -10px 28px rgba(0,0,0,.28);
}
#sheet.open{bottom:0}

/* Modal Create */
#modal-backdrop{
  position:fixed;inset:0;background:rgba(0,0,0,.35);
  display:none;align-items:center;justify-content:center;z-index:200;
}

#modal{
  width:min(680px,92vw);background:var(--card);
  border:2px solid var(--deic-green);border-radius:var(--radius);
  padding:1.5rem;box-shadow:0 10px 40px rgba(0,0,0,.3)
}

.modal-grid{
  display:grid;gap:1rem;grid-template-columns:1fr 1fr
}
.modal-grid .full{grid-column:1/-1}
textarea{min-height:110px;resize:vertical;}
</style>
</head>

<body>

<header>
  <div class="wrap">
    <div class="header-row">
      <div style="display:flex;align-items:center;gap:1rem">
        <div class="logo"></div>
        <h1>User Story Library</h1>
      </div>

      <div style="display:flex;gap:.5rem">
        <button id="openModal" class="btn btn-primary">New Story</button>
      </div>
    </div>

    <div class="filters">
      <div class="filter-top">
        <input id="search" placeholder="Searchâ€¦"/>
        <select id="sort">
          <option value="newest">Newest</option>
          <option value="oldest">Oldest</option>
        </select>
        <button id="refresh" class="btn btn-primary">Refresh</button>
        <button id="clearFilters" class="btn btn-secondary">Clear</button>
      </div>

      <div class="facets">
        <div class="facet">
          <div class="facet-header">
            <h3 class="facet-title">Contact Consent</h3>
          </div>
          <div class="facet-body"><div id="facetConsent" class="chip-row"></div></div>
        </div>

        <div class="facet collapsed">
          <div class="facet-header">
            <h3 class="facet-title">Domain</h3>
          </div>
          <div class="facet-body"><div id="facetDomain" class="chip-row"></div></div>
        </div>

        <div class="facet collapsed">
          <div class="facet-header">
            <h3 class="facet-title">Institution</h3>
          </div>
          <div class="facet-body"><div id="facetInstitution" class="chip-row"></div></div>
        </div>
      </div>
    </div>
  </div>
</header>


<div class="wrap">
  <section id="storyGrid" class="grid"></section>
  <div id="empty" style="display:none;text-align:center;color:var(--muted)">
    No stories found.
  </div>
</div>

<!-- Preview -->
<div id="sheet-backdrop"></div>
<div id="sheet">
  <h2 id="sheetTitle"></h2>
  <div id="sheetContent"></div>
</div>

<!-- Modal Create -->
<div id="modal-backdrop">
  <div id="modal">
    <h2>Create User Story</h2>

    <form id="storyForm">
      <div class="modal-grid">

        <div class="full">
          <label>Title</label>
          <input id="titleInput" required />
        </div>

        <div>
          <label>As aâ€¦</label>
          <input id="roleInput"/>
        </div>

        <div>
          <label>I want toâ€¦</label>
          <input id="goalInput"/>
        </div>

        <div class="full">
          <label>â€¦so that I canâ€¦</label>
          <input id="benefitInput"/>
        </div>

        <div class="full">
          <label>Additional context</label>
          <textarea id="contextInput"></textarea>
        </div>

        <div class="full">
          <label>Contact consent</label>
          <select id="consentInput">
            <option>Yes</option>
            <option>No</option>
            <option selected>N/A</option>
          </select>
        </div>

        <div class="full">
          <label>Labels</label>
          <input id="labelsInput" value="user-story"/>
        </div>

      </div>

      <div style="text-align:right;margin-top:1rem">
        <button type="button" id="cancelModal" class="btn btn-secondary">Cancel</button>
        <button class="btn btn-primary">Create</button>
      </div>
    </form>
  </div>
</div>

<script>
const OWNER="BrigitaPVoll";
const REPO ="User_Story_Library";

const LABELS = [
  "Contact consent>NO","Contact consent>YES",
  "Domain>Agricultural Sciences","Domain>Domain agnostic","Domain>Engineering and Technology",
  "Domain>Humanities","Domain>Medical and Health Sciences","Domain>Natural Sciences","Domain>Social Sciences",
  "Institution>Aalborg University","Institution>Aarhus University","Institution>Copenhagen Business School (CBS)",
  "Institution>IT University of Copenhagen","Institution>Roskilde University",
  "Institution>Technical University of Denmark (DTU)",
  "Institution>University of Copenhagen","Institution>University of Southern Denmark (SDU)"
];

const FACETS = {
  consent: LABELS.filter(x=>x.startsWith("Contact")),
  domain: LABELS.filter(x=>x.startsWith("Domain")),
  inst: LABELS.filter(x=>x.startsWith("Institution"))
};

const $ = q=>document.querySelector(q);
function esc(s){return String(s||"").replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));}

let issues=[],filtered=[],activeChips=new Set();

/* Build facet chips */
function buildFacet(id,list){
  const el=$(id); el.innerHTML="";
  list.forEach(L=>{
    const chip=document.createElement("div");
    chip.className="chip";
    chip.textContent=L.split(">")[1];
    chip.dataset.value=L;
    chip.onclick=()=>{
      if(activeChips.has(L)) activeChips.delete(L);
      else activeChips.add(L);
      chip.classList.toggle("selected");
      applyFilters();
    };
    el.appendChild(chip);
  });
}

buildFacet("#facetConsent",FACETS.consent);
buildFacet("#facetDomain",FACETS.domain);
buildFacet("#facetInstitution",FACETS.inst);

/* Load Issues */
async function loadIssues(){
  const res=await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/issues?state=all&per_page=100`);
  const d=await res.json();
  issues=d.filter(x=>!x.pull_request);
  applyFilters();
}

function applyFilters(){
  const q=$("#search").value.toLowerCase();

  filtered=issues.filter(it=>{
    if(q && !(`${it.title} ${it.body}`.toLowerCase().includes(q))) return false;

    if(activeChips.size){
      const names=it.labels.map(l=>l.name);
      for(const L of activeChips){ if(!names.includes(L)) return false; }
    }
    return true;
  });

  if($("#sort").value==="newest")
    filtered.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
  else
    filtered.sort((a,b)=>new Date(a.created_at)-new Date(b.created_at));

  render();
}

function render(){
  const grid=$("#storyGrid");
  grid.innerHTML="";

  if(!filtered.length){
    $("#empty").style.display="block";
    return;
  }
  $("#empty").style.display="none";

  filtered.forEach(it=>{
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <h3>${esc(it.title)}</h3>
      <div class="labels">${it.labels.map(l=>`<span class="label">${esc(l.name)}</span>`).join("")}</div>
    `;
    card.onclick=()=>openSheet(it.number);
    grid.appendChild(card);
  });
}

/* Preview Sheet */
async function openSheet(n){
  $("#sheet-backdrop").style.display="block";
  $("#sheet").classList.add("open");

  const res=await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/issues/${n}`);
  const it=await res.json();

  $("#sheetTitle").textContent=it.title;
  $("#sheetContent").innerHTML=`
    <p><strong>ID:</strong> #${it.number}</p>
    <pre>${esc(it.body)}</pre>
  `;
}

$("#sheet-backdrop").onclick=()=>{
  $("#sheet-backdrop").style.display="none";
  $("#sheet").classList.remove("open");
};

/* Create Story */
$("#openModal").onclick=()=>$("#modal-backdrop").style.display="flex";
$("#cancelModal").onclick=()=>$("#modal-backdrop").style.display="none";

$("#storyForm").onsubmit=async e=>{
  e.preventDefault();

  const title=$("#titleInput").value.trim();
  const role=$("#roleInput").value.trim();
  const goal=$("#goalInput").value.trim();
  const benefit=$("#benefitInput").value.trim();
  const context=$("#contextInput").value.trim();
  const consent=$("#consentInput").value;
  const labels=$("#labelsInput").value.split(",").map(x=>x.trim()).filter(Boolean);
  if(!labels.includes("user-story")) labels.unshift("user-story");

  const body=[
    '---',
    'name: User Story',
    'about: FAIR use case',
    'title: "User Story"',
    'labels: ["user-story"]',
    'assignees: ""',
    '---',
    '',
    '## ðŸ§© User story',
    '**As a**', role || "â€¦",
    '',
    '**I want to**', goal || "â€¦",
    '',
    '**So that I can**', benefit || "â€¦",
    '',
    '---',
    '## ðŸ“Œ Additional context',
    context || "â€¦",
    '',
    '---',
    '## ðŸ“¬ Contact for future EOSC projects',
    consent==="Yes" ? '- [x] Yes\n- [ ] No'
      : consent==="No" ? '- [ ] Yes\n- [x] No'
      : '- [ ] Yes\n- [ ] No',
    ''
  ].join("\n");

  const res=await fetch("./api/createStory", {   // <-- fixed: relative path
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({title,body,labels})
  });

  if(!res.ok){
    const text=await res.text();
    if(text.includes("GitHub token missing")){
      alert("Error: TOKEN is missing in GitHub Pages settings.\nSettings â†’ Pages â†’ Environment variables â†’ Add 'TOKEN'");
    } else {
      alert("Failed to create story:\n" + text);
    }
    return;
  }

  alert("Story created!");
  $("#modal-backdrop").style.display="none";
  loadIssues();
};

/* INIT */
$("#search").oninput=applyFilters;
$("#sort").onchange=applyFilters;
$("#refresh").onclick=loadIssues;
$("#clearFilters").onclick=()=>{
  activeChips.clear();
  document.querySelectorAll(".chip").forEach(c=>c.classList.remove("selected"));
  $("#search").value="";
  loadIssues();
};

loadIssues();
</script>

</body>
</html>
